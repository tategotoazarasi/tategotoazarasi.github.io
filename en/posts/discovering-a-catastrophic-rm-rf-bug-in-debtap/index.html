<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Discovering a Delete-Your-Files-and-Run Level Bug in debtap | Tategoto Azarasi</title>
<meta name=keywords content="debtap,bug,rm-rf,shell-script,bash,arch-linux,pkgbuild,dirname,debugging,git,git-blame,open-source,data-loss,linux,command-line,software-development,code-review,typo"><meta name=description content="A deep-dive investigation into the Arch Linux tool debtap reveals how a well-intentioned typo fix accidentally activated a catastrophic rm -rf bug that deleted all files in the current working directory."><meta name=author content="Tategoto Azarasi"><link rel=canonical href=https://tategotoazarasi.github.io/en/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://tategotoazarasi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tategotoazarasi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tategotoazarasi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tategotoazarasi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tategotoazarasi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tategotoazarasi.github.io/en/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/><link rel=alternate hreflang=zh href=https://tategotoazarasi.github.io/zh/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR onload=renderMathInElement(document.body) src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js></script>>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://tategotoazarasi.github.io/en/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/"><meta property="og:site_name" content="Tategoto Azarasi"><meta property="og:title" content="Discovering a Delete-Your-Files-and-Run Level Bug in debtap"><meta property="og:description" content="A deep-dive investigation into the Arch Linux tool debtap reveals how a well-intentioned typo fix accidentally activated a catastrophic rm -rf bug that deleted all files in the current working directory."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-06T18:02:24+08:00"><meta property="article:modified_time" content="2025-08-06T18:02:24+08:00"><meta property="article:tag" content="Debtap"><meta property="article:tag" content="Bug"><meta property="article:tag" content="Rm-Rf"><meta property="article:tag" content="Shell-Script"><meta property="article:tag" content="Bash"><meta property="article:tag" content="Arch-Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Discovering a Delete-Your-Files-and-Run Level Bug in debtap"><meta name=twitter:description content="A deep-dive investigation into the Arch Linux tool debtap reveals how a well-intentioned typo fix accidentally activated a catastrophic rm -rf bug that deleted all files in the current working directory."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tategotoazarasi.github.io/en/posts/"},{"@type":"ListItem","position":2,"name":"Discovering a Delete-Your-Files-and-Run Level Bug in debtap","item":"https://tategotoazarasi.github.io/en/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Discovering a Delete-Your-Files-and-Run Level Bug in debtap","name":"Discovering a Delete-Your-Files-and-Run Level Bug in debtap","description":"A deep-dive investigation into the Arch Linux tool debtap reveals how a well-intentioned typo fix accidentally activated a catastrophic rm -rf bug that deleted all files in the current working directory.","keywords":["debtap","bug","rm-rf","shell-script","bash","arch-linux","pkgbuild","dirname","debugging","git","git-blame","open-source","data-loss","linux","command-line","software-development","code-review","typo"],"articleBody":"The story begins, as many do, quite mundanely. I needed to install a piece of software called SwashbucklerDiary, which was only officially available as a .deb package. For an Arch Linux user, this is hardly a problem; the debtap utility was made for exactly this scenario.\nAs is my usual practice, I created a temporary directory to handle the conversion, ensuring I wouldn’t clutter my main Downloads folder.\n\u003e pwd /home/myusername/Downloads/tmp \u003e ls SwashbucklerDiary-1.17.0-linux-x64.deb Everything looked normal. The directory contained only the .deb file I had just downloaded. I first ran the standard debtap command, and it successfully generated the pkg.tar.zst package I needed.\n\u003e debtap SwashbucklerDiary-1.17.0-linux-x64.deb ... (conversion process output omitted) ... ==\u003e Package successfully created! ==\u003e Removing leftover files... \u003e ls -alh total 106M drwxr-xr-x 2 myusername myusername 116 Aug 6 12:34 . drwxr-xr-x 4 myusername myusername 41 Aug 6 12:34 .. -rw-r--r-- 1 myusername root 58M Aug 6 12:34 com.yucore.swashbucklerdiary-1.17.0-1-x86_64.pkg.tar.zst -rw-r--r-- 1 myusername myusername 49M Aug 4 18:14 SwashbucklerDiary-1.17.0-linux-x64.deb Perfect. The converted package and the original .deb file were both present. But then, driven by curiosity and a desire to learn, I decided I wanted to see what the PKGBUILD file generated by debtap looked like. The tool provides the -p or -P flag for this purpose. So, I deleted the newly created package and ran the command again, this time with the -p flag.\n\u003e debtap -p SwashbucklerDiary-1.17.0-linux-x64.deb ... (same interactive prompts) ... ==\u003e Package successfully created! ==\u003e Generating PKGBUILD file... mv: cannot stat 'PKGBUILD': No such file or directory ==\u003e PKGBUILD is now located in \"/home/myusername/Downloads/tmp\" and ready to be edited ==\u003e Removing leftover files... The output seemed a bit odd. There was an error message: mv: cannot stat 'PKGBUILD': No such file or directory. But the final line still confidently informed me that the PKGBUILD had been generated in the current directory. I didn’t think much of it and habitually typed ls -alh.\nThen, I saw something that sent a chill down my spine.\n\u003e ls -alh total 0 Completely empty.\nMy first reaction was shock. Not only was the expected PKGBUILD directory missing, but the original .deb file had also vanished! The entire tmp directory had been wiped clean.\nStranger things were yet to come. I tried to cd .. and then cd tmp back into the directory. My shell prompt (I use Oh My Zsh with Powerlevel10k) displayed some bizarre artifacts, as if the directory’s metadata itself had been corrupted. When I ran ls -alh again, I was greeted with an even more bewildering output:\n\u003e ls -alh total 0 drwxr-xr-x 2 myusername myusername 6 Aug 6 12:35 . drwxr-xr-x 4 myusername myusername 41 Aug 6 12:35 .. Look at the size of the . directory: 6 bytes. A normal, freshly emptied directory on my XFS filesystem should be 4096 bytes. This was highly unusual.\nMy mind started racing. My /home directory is on a RAID0 array of two SSDs, formatted with XFS. My first thought was, “It’s over. Did my RAID0 array just fail? Did one of the drives die?” The high performance of RAID0 comes at the cost of zero redundancy; the failure of a single drive means the loss of all data on the array. I immediately started checking dmesg and system logs, but I found no signs of I/O errors or filesystem corruption.\nAfter ruling out hardware and filesystem issues, I calmed down and started to suspect debtap itself. Since the first run without -p was normal, and the second run with -p caused the disaster, the problem had to be linked to that specific flag.\nI decided to reproduce the issue, but this time in a completely safe environment. I created a new test directory, populated it with a few harmless dummy files, and a copy of the .deb package.\nmkdir ~/safe-test cd ~/safe-test touch fileA.txt fileB.log cp ~/Downloads/SwashbucklerDiary-1.17.0-linux-x64.deb . ls -l # total 49264 # -rw-r--r-- 1 myusername myusername 50442386 Aug 4 18:14 SwashbucklerDiary-1.17.0-linux-x64.deb # -rw-r--r-- 1 myusername myusername 0 Aug 6 13:00 fileA.txt # -rw-r--r-- 1 myusername myusername 0 Aug 6 13:00 fileB.log Then, holding my breath, I executed the “demonic” command once more:\ndebtap -p SwashbucklerDiary-1.17.0-linux-x64.deb After the process finished, I ran ls.\nls -l # total 0 The result was identical. The directory was wiped clean.\nAt this point, the case was clear. This was no paranormal event or hardware failure. It was an extremely dangerous bug in debtap that, when used with the -p or -P flag, would delete all files in the current working directory.\nWith the problem identified, the next step was to find the cause. debtap is a shell script, which makes source code analysis very straightforward. I opened /usr/bin/debtap, version 3.6.2. It was a massive script, over three thousand lines long, so a full read-through was out of the question.\nMy investigation had a clear focus:\nThe bug is strongly correlated with the -p/-P flags. The function of these flags is to generate a PKGBUILD. The final result is the deletion of the current directory. Therefore, I needed to find the code block in the script that handled the -p/-P flags and was responsible for generating and moving the PKGBUILD file. I searched the code for the keyword pkgbuild.\nNear the end of the script, I quickly found the logic for handling the PKGBUILD creation.\n# ... (code for generating PKGBUILD content) ... # Moving PKGBUILD (and .INSTALL, if it exists) and announcing its creation pkgname=\"$(grep '^pkgname=' PKGBUILD | sed s'/^pkgname=//')\" if [[ $output == set ]]; then pkgbuild_location=\"$(dirname \"$outputdirectory/$pkgname-PKGBUILD\")\" rm -rf \"$pkgbuild_location\" 2\u003e /dev/null mkdir \"$pkgbuild_location\" 2\u003e /dev/null # ... (error handling and file moving code) ... else pkgbuild_location=\"$(dirname \"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\")\" rm -rf \"$pkgbuild_location\" 2\u003e /dev/null mkdir \"$pkgbuild_location\" 2\u003e /dev/null # ... (error handling and file moving code) ... fi My eyes were immediately drawn to the line rm -rf \"$pkgbuild_location\". This was, without a doubt, the prime suspect. The script was executing a forced, recursive delete command. The question now was: what was the actual value of the $pkgbuild_location variable?\nLet’s focus on the key line in the else block, which is where execution goes since I didn’t use the -o output directory option:\npkgbuild_location=\"$(dirname \"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\")\" This line looks a bit complex, with two nested dirname commands. Let’s dissect it and analyze its execution step by step.\ndirname is a basic shell command that strips the filename from a path, returning only the directory path. For example:\ndirname /usr/bin/ls returns /usr/bin dirname /home/user/file.txt returns /home/user Now, let’s substitute the actual variable values from my session.\n$package_with_full_path: This variable is defined at the beginning of the script as the absolute path to the input .deb file. In my case, its value was /home/myusername/Downloads/tmp/SwashbucklerDiary-1.17.0-linux-x64.deb. $pkgname: This variable is extracted from the temporarily generated PKGBUILD file. According to my logs, the converted package name was com.yucore.swashbucklerdiary-1.17.0-1. Now, let’s trace the nested command:\nStep 1: Execute the inner dirname\n\"$(dirname \"$package_with_full_path\")\" # Becomes: \"$(dirname \"/home/myusername/Downloads/tmp/SwashbucklerDiary-1.17.0-linux-x64.deb\")\" The output of this step is the directory containing the .deb file: /home/myusername/Downloads/tmp.\nStep 2: Concatenate the string\nThe result from the previous step is then concatenated with the rest of the string, forming a longer path:\n\"/home/myusername/Downloads/tmp/$pkgname-PKGBUILD\" # Substituting $pkgname: \"/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD\" This string represents a path… wait, this looks like a file path, not a directory. The author’s intent was likely to create a directory named packagename-PKGBUILD to place the PKGBUILD file into.\nStep 3: Execute the outer dirname\nNow for the most critical step. The script takes the entire string generated in Step 2 and runs the outer dirname on it:\n\"$(dirname \"/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD\")\" And what is the output of this command? It is /home/myusername/Downloads/tmp!\nThe Truth is Revealed\nAfter these three steps, we have the final value of the pkgbuild_location variable: /home/myusername/Downloads/tmp, which was the current working directory where I ran the debtap command.\nNow let’s look back at those fatal lines of code:\npkgbuild_location=\"/home/myusername/Downloads/tmp\" rm -rf \"$pkgbuild_location\" # Effectively becomes: rm -rf \"/home/myusername/Downloads/tmp\" mkdir \"$pkgbuild_location\" # Effectively becomes: mkdir \"/home/myusername/Downloads/tmp\" The mystery was solved. The script first calculated the wrong path—the current working directory—and then, without hesitation, executed rm -rf, deleting the directory and everything inside it (including my original .deb file). Immediately after, the mkdir command recreated the directory, which is why I was left with an empty tmp directory whose metadata appeared to have been “initialized.”\nThis was a classic yet terrifying logical error. The author likely intended to ensure the target directory was clean by deleting and recreating it. However, the incorrect use of a double dirname caused the deletion target to shift from the “intended subdirectory” to the “entire current directory.”\nAfter discovering the root cause, a new thought occurred to me: a bug this severe couldn’t have been in debtap for long, or it would have been discovered ages ago. It must have been introduced recently.\nI decided to do some “code archeology” in the debtap GitHub repository to uncover the bug’s history. Using git blame and browsing the commit history, I quickly zeroed in on a suspicious commit: commit 27a9ff5.\nThe commit message was a simple code update. Let’s look at its diff:\ndiff --git a/debtap b/debtap index 4518a7a..71aea20 100755 --- a/debtap +++ b/debtap @@ -3458,8 +3458,8 @@ if [[ $output == set ]]; then fi else pkgbuild_location=\"$(dirname \"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\")\" - rm -rf \"$pkgbuilt_location\" 2\u003e /dev/null - mkdir \"$pkgbuilt_location\" 2\u003e /dev/null + rm -rf \"$pkgbuild_location\" 2\u003e /dev/null + mkdir \"$pkgbuild_location\" 2\u003e /dev/null if [[ $? != 0 ]]; then echo -e \"${red}Error: Cannot create PKGBUILD directory to the same directory as .deb package, permission denied. Removing leftover files and exiting...${NC}\" rm -rf \"$working_directory\" Seeing this, it all clicked, and I didn’t know whether to laugh or cry.\nBefore this commit, the code was:\nrm -rf \"$pkgbuilt_location\" 2\u003e /dev/null mkdir \"$pkgbuilt_location\" 2\u003e /dev/null Notice the variable name: pkgbuilt_location. But the variable defined above was named pkgbuild_location. It was a * typo*!\nIn shell scripting, referencing a non-existent variable (due to a typo, for instance) causes it to expand to an empty string. Therefore, before commit 27a9ff5, the commands being executed were effectively:\nrm -rf \"\" 2\u003e /dev/null mkdir \"\" 2\u003e /dev/null rm -rf \"\" and mkdir \"\" do nothing and produce no errors. Thus, although the flawed dirname logic was calculating the wrong path, this typo prevented it from ever being used in the rm -rf command. The typo acted like a safety fuse, unintentionally protecting countless users’ data by a strange twist of fate.\nThe author of commit 27a9ff5 likely spotted this typo during a code review and, with the good intention of “fixing the code,” changed pkgbuilt_location to the correct pkgbuild_location. He “fixed” the typo, but in doing so, he unwittingly armed the bomb.\nIt’s a textbook case of how a seemingly trivial, well-intentioned change can lead to catastrophic consequences if the full context and potential impact are not understood.\nHaving unraveled the entire story, I knew I had to report this to the project maintainer immediately to prevent more users from falling victim. I quickly created a new issue on the debtap GitHub repository.\nThe issue got a swift response from the community. Other users confirmed they had encountered the same problem, with one user expressing relief that they hadn’t run the command in their $HOME directory—a comment that further underscored the bug’s severity.\nThe project maintainer, helixarch, took notice quickly and released a fix a few days later. Let’s look at the core diff that fixed the bug:\n--- a/debtap +++ b/debtap @@ -3486,7 +3486,7 @@ if [[ $output == set ]]; then echo -e \"${lightgreen}==\u003e${NC} ${bold}PKGBUILD is now located in${normal} ${lightblue}\\\"$pkgbuild_location\\\"${NC} ${bold}and ready to be edited${normal}\" fi else - pkgbuild_location=\"$(dirname \"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\")\" + pkgbuild_location=\"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\" rm -rf \"$pkgbuild_location\" 2\u003e /dev/null mkdir \"$pkgbuild_location\" 2\u003e /dev/null if [[ $? != 0 ]]; then The fix was direct and elegant. The maintainer removed the outer dirname.\nNow, the calculation for pkgbuild_location became:\npkgbuild_location=\"\"$(dirname \"$package_with_full_path\")\"/$pkgname-PKGBUILD\" Let’s trace this new logic:\ndirname \"$package_with_full_path\" is still /home/myusername/Downloads/tmp. The concatenated string is /home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD. This value is now directly assigned to pkgbuild_location. Consequently, the subsequent commands become:\nrm -rf \"/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD\" mkdir \"/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD\" This is exactly the behavior we want! The script now correctly creates a new, clean subdirectory within the current directory to store the PKGBUILD file, without posing any threat to the current directory itself.\nWith the release of debtap 3.6.3, this heart-stopping bug was finally squashed.\n","wordCount":"2059","inLanguage":"en","datePublished":"2025-08-06T18:02:24+08:00","dateModified":"2025-08-06T18:02:24+08:00","author":{"@type":"Person","name":"Tategoto Azarasi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tategotoazarasi.github.io/en/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/"},"publisher":{"@type":"Organization","name":"Tategoto Azarasi","logo":{"@type":"ImageObject","url":"https://tategotoazarasi.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tategotoazarasi.github.io/en/ accesskey=h title="Tategoto Azarasi (Alt + H)">Tategoto Azarasi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://tategotoazarasi.github.io/zh/ title=中文 aria-label=中文>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://tategotoazarasi.github.io/en/ title=Home><span>Home</span></a></li><li><a href=https://tategotoazarasi.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://tategotoazarasi.github.io/en/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tategotoazarasi.github.io/en/>Home</a>&nbsp;»&nbsp;<a href=https://tategotoazarasi.github.io/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Discovering a Delete-Your-Files-and-Run Level Bug in debtap</h1><div class=post-meta><span title='2025-08-06 18:02:24 +0800 +0800'>August 6, 2025</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2059 words&nbsp;·&nbsp;Tategoto Azarasi&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://tategotoazarasi.github.io/zh/posts/discovering-a-catastrophic-rm-rf-bug-in-debtap/>Zh</a></li></ul></div></header><div class=post-content><p>The story begins, as many do, quite mundanely. I needed to install a piece of software called <code>SwashbucklerDiary</code>, which
was only officially available as a <code>.deb</code> package. For an Arch Linux user, this is hardly a problem; the <code>debtap</code>
utility was made for exactly this scenario.</p><p>As is my usual practice, I created a temporary directory to handle the conversion, ensuring I wouldn&rsquo;t clutter my main
Downloads folder.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; pwd
</span></span><span style=display:flex><span>/home/myusername/Downloads/tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; ls
</span></span><span style=display:flex><span>SwashbucklerDiary-1.17.0-linux-x64.deb
</span></span></code></pre></div><p>Everything looked normal. The directory contained only the <code>.deb</code> file I had just downloaded. I first ran the standard
<code>debtap</code> command, and it successfully generated the <code>pkg.tar.zst</code> package I needed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; debtap SwashbucklerDiary-1.17.0-linux-x64.deb
</span></span><span style=display:flex><span>... <span style=color:#f92672>(</span>conversion process output omitted<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; Package successfully created!
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; Removing leftover files...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; ls -alh
</span></span><span style=display:flex><span>total 106M
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>2</span> myusername myusername <span style=color:#ae81ff>116</span> Aug  <span style=color:#ae81ff>6</span> 12:34 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>4</span> myusername myusername  <span style=color:#ae81ff>41</span> Aug  <span style=color:#ae81ff>6</span> 12:34 ..
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> myusername root        58M Aug  <span style=color:#ae81ff>6</span> 12:34 com.yucore.swashbucklerdiary-1.17.0-1-x86_64.pkg.tar.zst
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> myusername myusername 49M Aug  <span style=color:#ae81ff>4</span> 18:14 SwashbucklerDiary-1.17.0-linux-x64.deb
</span></span></code></pre></div><p>Perfect. The converted package and the original <code>.deb</code> file were both present. But then, driven by curiosity and a
desire to learn, I decided I wanted to see what the <code>PKGBUILD</code> file generated by <code>debtap</code> looked like. The tool provides
the <code>-p</code> or <code>-P</code> flag for this purpose. So, I deleted the newly created package and ran the command again, this time
with the <code>-p</code> flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; debtap -p SwashbucklerDiary-1.17.0-linux-x64.deb
</span></span><span style=display:flex><span>... <span style=color:#f92672>(</span>same interactive prompts<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; Package successfully created!
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; Generating PKGBUILD file...
</span></span><span style=display:flex><span>mv: cannot stat <span style=color:#e6db74>&#39;PKGBUILD&#39;</span>: No such file or directory
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; PKGBUILD is now located in <span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp&#34;</span> and ready to be edited
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; Removing leftover files...
</span></span></code></pre></div><p>The output seemed a bit odd. There was an error message: <code>mv: cannot stat 'PKGBUILD': No such file or directory</code>. But
the final line still confidently informed me that the <code>PKGBUILD</code> had been generated in the current directory. I didn&rsquo;t
think much of it and habitually typed <code>ls -alh</code>.</p><p>Then, I saw something that sent a chill down my spine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; ls -alh
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Completely empty.</p><p>My first reaction was shock. Not only was the expected <code>PKGBUILD</code> directory missing, but the original <code>.deb</code> file had
also vanished! The entire <code>tmp</code> directory had been wiped clean.</p><p>Stranger things were yet to come. I tried to <code>cd ..</code> and then <code>cd tmp</code> back into the directory. My shell prompt (I use
Oh My Zsh with Powerlevel10k) displayed some bizarre artifacts, as if the directory&rsquo;s metadata itself had been
corrupted. When I ran <code>ls -alh</code> again, I was greeted with an even more bewildering output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; ls -alh
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>2</span> myusername myusername  <span style=color:#ae81ff>6</span> Aug  <span style=color:#ae81ff>6</span> 12:35 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>4</span> myusername myusername <span style=color:#ae81ff>41</span> Aug  <span style=color:#ae81ff>6</span> 12:35 ..
</span></span></code></pre></div><p>Look at the size of the <code>.</code> directory: 6 bytes. A normal, freshly emptied directory on my XFS filesystem should be 4096
bytes. This was highly unusual.</p><p>My mind started racing. My <code>/home</code> directory is on a RAID0 array of two SSDs, formatted with XFS. My first thought
was, &ldquo;It&rsquo;s over. Did my RAID0 array just fail? Did one of the drives die?&rdquo; The high performance of RAID0 comes at the
cost of zero redundancy; the failure of a single drive means the loss of all data on the array. I immediately started
checking <code>dmesg</code> and system logs, but I found no signs of I/O errors or filesystem corruption.</p><p>After ruling out hardware and filesystem issues, I calmed down and started to suspect <code>debtap</code> itself. Since the first
run without <code>-p</code> was normal, and the second run with <code>-p</code> caused the disaster, the problem had to be linked to that
specific flag.</p><p>I decided to reproduce the issue, but this time in a completely safe environment. I created a new test directory,
populated it with a few harmless dummy files, and a copy of the <code>.deb</code> package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/safe-test
</span></span><span style=display:flex><span>cd ~/safe-test
</span></span><span style=display:flex><span>touch fileA.txt fileB.log
</span></span><span style=display:flex><span>cp ~/Downloads/SwashbucklerDiary-1.17.0-linux-x64.deb .
</span></span><span style=display:flex><span>ls -l
</span></span><span style=display:flex><span><span style=color:#75715e># total 49264</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -rw-r--r-- 1 myusername myusername 50442386 Aug  4 18:14 SwashbucklerDiary-1.17.0-linux-x64.deb</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -rw-r--r-- 1 myusername myusername        0 Aug  6 13:00 fileA.txt</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -rw-r--r-- 1 myusername myusername        0 Aug  6 13:00 fileB.log</span>
</span></span></code></pre></div><p>Then, holding my breath, I executed the &ldquo;demonic&rdquo; command once more:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debtap -p SwashbucklerDiary-1.17.0-linux-x64.deb
</span></span></code></pre></div><p>After the process finished, I ran <code>ls</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l
</span></span><span style=display:flex><span><span style=color:#75715e># total 0</span>
</span></span></code></pre></div><p>The result was identical. The directory was wiped clean.</p><p>At this point, the case was clear. This was no paranormal event or hardware failure. It was an extremely dangerous bug
in <code>debtap</code> that, when used with the <code>-p</code> or <code>-P</code> flag, would delete all files in the current working directory.</p><p>With the problem identified, the next step was to find the cause. <code>debtap</code> is a shell script, which makes source code
analysis very straightforward. I opened <code>/usr/bin/debtap</code>, version <code>3.6.2</code>. It was a massive script, over three thousand
lines long, so a full read-through was out of the question.</p><p>My investigation had a clear focus:</p><ol><li>The bug is strongly correlated with the <code>-p</code>/<code>-P</code> flags.</li><li>The function of these flags is to generate a <code>PKGBUILD</code>.</li><li>The final result is the deletion of the current directory.</li></ol><p>Therefore, I needed to find the code block in the script that handled the <code>-p</code>/<code>-P</code> flags and was responsible for
generating and moving the <code>PKGBUILD</code> file. I searched the code for the keyword <code>pkgbuild</code>.</p><p>Near the end of the script, I quickly found the logic for handling the <code>PKGBUILD</code> creation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ... (code for generating PKGBUILD content) ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Moving PKGBUILD (and .INSTALL, if it exists) and announcing its creation</span>
</span></span><span style=display:flex><span>pkgname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>grep <span style=color:#e6db74>&#39;^pkgname=&#39;</span> PKGBUILD | sed s<span style=color:#e6db74>&#39;/^pkgname=//&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $output <span style=color:#f92672>==</span> set <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    pkgbuild_location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$outputdirectory<span style=color:#e6db74>/</span>$pkgname<span style=color:#e6db74>-PKGBUILD&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    rm -rf <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>    mkdir <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#75715e># ... (error handling and file moving code) ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    pkgbuild_location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$package_with_full_path<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;/</span>$pkgname<span style=color:#e6db74>-PKGBUILD&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    rm -rf <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>    mkdir <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#75715e># ... (error handling and file moving code) ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>My eyes were immediately drawn to the line <code>rm -rf "$pkgbuild_location"</code>. This was, without a doubt, the prime suspect.
The script was executing a forced, recursive delete command. The question now was: what was the actual value of the
<code>$pkgbuild_location</code> variable?</p><p>Let&rsquo;s focus on the key line in the <code>else</code> block, which is where execution goes since I didn&rsquo;t use the <code>-o</code> output
directory option:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pkgbuild_location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$package_with_full_path<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;/</span>$pkgname<span style=color:#e6db74>-PKGBUILD&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>This line looks a bit complex, with two nested <code>dirname</code> commands. Let&rsquo;s dissect it and analyze its execution step by
step.</p><p><code>dirname</code> is a basic shell command that strips the filename from a path, returning only the directory path. For example:</p><ul><li><code>dirname /usr/bin/ls</code> returns <code>/usr/bin</code></li><li><code>dirname /home/user/file.txt</code> returns <code>/home/user</code></li></ul><p>Now, let&rsquo;s substitute the actual variable values from my session.</p><ol><li><strong><code>$package_with_full_path</code></strong>: This variable is defined at the beginning of the script as the absolute path to the
input <code>.deb</code> file. In my case, its value was <code>/home/myusername/Downloads/tmp/SwashbucklerDiary-1.17.0-linux-x64.deb</code>.</li><li><strong><code>$pkgname</code></strong>: This variable is extracted from the temporarily generated <code>PKGBUILD</code> file. According to my logs, the
converted package name was <code>com.yucore.swashbucklerdiary-1.17.0-1</code>.</li></ol><p>Now, let&rsquo;s trace the nested command:</p><p><strong>Step 1: Execute the inner <code>dirname</code></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$package_with_full_path<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Becomes:</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/SwashbucklerDiary-1.17.0-linux-x64.deb&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>The output of this step is the directory containing the <code>.deb</code> file: <code>/home/myusername/Downloads/tmp</code>.</p><p><strong>Step 2: Concatenate the string</strong></p><p>The result from the previous step is then concatenated with the rest of the string, forming a longer path:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/</span>$pkgname<span style=color:#e6db74>-PKGBUILD&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Substituting $pkgname:</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD&#34;</span>
</span></span></code></pre></div><p>This string represents a path&mldr; wait, this looks like a <strong>file</strong> path, not a directory. The author&rsquo;s intent was likely
to create a <strong>directory</strong> named <code>packagename-PKGBUILD</code> to place the <code>PKGBUILD</code> file into.</p><p><strong>Step 3: Execute the outer <code>dirname</code></strong></p><p>Now for the most critical step. The script takes the entire string generated in Step 2 and runs the outer <code>dirname</code> on
it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>And what is the output of this command? It is <code>/home/myusername/Downloads/tmp</code>!</p><p><strong>The Truth is Revealed</strong></p><p>After these three steps, we have the final value of the <code>pkgbuild_location</code> variable: <code>/home/myusername/Downloads/tmp</code>,
which was the <strong>current working directory</strong> where I ran the <code>debtap</code> command.</p><p>Now let&rsquo;s look back at those fatal lines of code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pkgbuild_location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp&#34;</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span>  <span style=color:#75715e># Effectively becomes: rm -rf &#34;/home/myusername/Downloads/tmp&#34;</span>
</span></span><span style=display:flex><span>mkdir <span style=color:#e6db74>&#34;</span>$pkgbuild_location<span style=color:#e6db74>&#34;</span> <span style=color:#75715e># Effectively becomes: mkdir &#34;/home/myusername/Downloads/tmp&#34;</span>
</span></span></code></pre></div><p>The mystery was solved. The script first calculated the wrong path—the current working directory—and then, without
hesitation, executed <code>rm -rf</code>, deleting the directory and everything inside it (including my original <code>.deb</code> file).
Immediately after, the <code>mkdir</code> command recreated the directory, which is why I was left with an empty <code>tmp</code> directory
whose metadata appeared to have been &ldquo;initialized.&rdquo;</p><p>This was a classic yet terrifying logical error. The author likely intended to ensure the target directory was clean by
deleting and recreating it. However, the incorrect use of a double <code>dirname</code> caused the deletion target to shift from
the &ldquo;intended subdirectory&rdquo; to the &ldquo;entire current directory.&rdquo;</p><p>After discovering the root cause, a new thought occurred to me: a bug this severe couldn&rsquo;t have been in <code>debtap</code> for
long, or it would have been discovered ages ago. It must have been introduced recently.</p><p>I decided to do some &ldquo;code archeology&rdquo; in the <code>debtap</code> GitHub repository to uncover the bug&rsquo;s history. Using <code>git blame</code>
and browsing the commit history, I quickly zeroed in on a suspicious commit: <strong>commit <code>27a9ff5</code></strong>.</p><p>The commit message was a simple code update. Let&rsquo;s look at its <code>diff</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/debtap b/debtap
</span></span><span style=display:flex><span>index 4518a7a..71aea20 100755
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/debtap
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/debtap
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -3458,8 +3458,8 @@ if [[ $output == set ]]; then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    fi
</span></span><span style=display:flex><span> else
</span></span><span style=display:flex><span>    pkgbuild_location=&#34;$(dirname &#34;&#34;$(dirname &#34;$package_with_full_path&#34;)&#34;/$pkgname-PKGBUILD&#34;)&#34;
</span></span><span style=display:flex><span><span style=color:#f92672>-   rm -rf &#34;$pkgbuilt_location&#34; 2&gt; /dev/null
</span></span></span><span style=display:flex><span><span style=color:#f92672>-   mkdir &#34;$pkgbuilt_location&#34; 2&gt; /dev/null
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+   rm -rf &#34;$pkgbuild_location&#34; 2&gt; /dev/null
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+   mkdir &#34;$pkgbuild_location&#34; 2&gt; /dev/null
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>    if [[ $? != 0 ]]; then
</span></span><span style=display:flex><span>        echo -e &#34;${red}Error: Cannot create PKGBUILD directory to the same directory as .deb package, permission denied. Removing leftover files and exiting...${NC}&#34;
</span></span><span style=display:flex><span>        rm -rf &#34;$working_directory&#34;
</span></span></code></pre></div><p>Seeing this, it all clicked, and I didn&rsquo;t know whether to laugh or cry.</p><p>Before this commit, the code was:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span>$pkgbuilt_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>mkdir <span style=color:#e6db74>&#34;</span>$pkgbuilt_location<span style=color:#e6db74>&#34;</span> 2&gt; /dev/null
</span></span></code></pre></div><p>Notice the variable name: <code>pkgbuilt_location</code>. But the variable defined above was named <code>pkgbuild_location</code>. It was a *
<em>typo</em>*!</p><p>In shell scripting, referencing a non-existent variable (due to a typo, for instance) causes it to expand to an empty
string. Therefore, before commit <code>27a9ff5</code>, the commands being executed were effectively:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;&#34;</span> 2&gt; /dev/null
</span></span><span style=display:flex><span>mkdir <span style=color:#e6db74>&#34;&#34;</span> 2&gt; /dev/null
</span></span></code></pre></div><p><code>rm -rf ""</code> and <code>mkdir ""</code> do nothing and produce no errors. Thus, although the flawed <code>dirname</code> logic was calculating
the wrong path, this typo prevented it from ever being used in the <code>rm -rf</code> command. The typo acted like a safety fuse,
unintentionally protecting countless users&rsquo; data by a strange twist of fate.</p><p>The author of <strong>commit <code>27a9ff5</code></strong> likely spotted this typo during a code review and, with the good intention of &ldquo;fixing
the code,&rdquo; changed <code>pkgbuilt_location</code> to the correct <code>pkgbuild_location</code>. He &ldquo;fixed&rdquo; the typo, but in doing so, he
unwittingly armed the bomb.</p><p>It&rsquo;s a textbook case of how a seemingly trivial, well-intentioned change can lead to catastrophic consequences if the
full context and potential impact are not understood.</p><p>Having unraveled the entire story, I knew I had to report this to the project maintainer immediately to prevent more
users from falling victim. I quickly created a new issue on the <code>debtap</code> GitHub repository.</p><p>The issue got a swift response from the community. Other users confirmed they had encountered the same problem, with one
user expressing relief that they hadn&rsquo;t run the command in their <code>$HOME</code> directory—a comment that further underscored
the bug&rsquo;s severity.</p><p>The project maintainer, helixarch, took notice quickly and released a fix a few days later. Let&rsquo;s look at the core
<code>diff</code> that fixed the bug:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>--- a/debtap
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/debtap
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -3486,7 +3486,7 @@ if [[ $output == set ]]; then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        echo -e &#34;${lightgreen}==&gt;${NC} ${bold}PKGBUILD is now located in${normal} ${lightblue}\&#34;$pkgbuild_location\&#34;${NC} ${bold}and ready to be edited${normal}&#34;
</span></span><span style=display:flex><span>    fi
</span></span><span style=display:flex><span> else
</span></span><span style=display:flex><span><span style=color:#f92672>-   pkgbuild_location=&#34;$(dirname &#34;&#34;$(dirname &#34;$package_with_full_path&#34;)&#34;/$pkgname-PKGBUILD&#34;)&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+   pkgbuild_location=&#34;&#34;$(dirname &#34;$package_with_full_path&#34;)&#34;/$pkgname-PKGBUILD&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>    rm -rf &#34;$pkgbuild_location&#34; 2&gt; /dev/null
</span></span><span style=display:flex><span>    mkdir &#34;$pkgbuild_location&#34; 2&gt; /dev/null
</span></span><span style=display:flex><span>    if [[ $? != 0 ]]; then
</span></span></code></pre></div><p>The fix was direct and elegant. The maintainer <strong>removed the outer <code>dirname</code></strong>.</p><p>Now, the calculation for <code>pkgbuild_location</code> became:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pkgbuild_location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$package_with_full_path<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;/</span>$pkgname<span style=color:#e6db74>-PKGBUILD&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s trace this new logic:</p><ol><li><code>dirname "$package_with_full_path"</code> is still <code>/home/myusername/Downloads/tmp</code>.</li><li>The concatenated string is <code>/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD</code>.</li></ol><p>This value is now directly assigned to <code>pkgbuild_location</code>. Consequently, the subsequent commands become:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD&#34;</span>
</span></span><span style=display:flex><span>mkdir <span style=color:#e6db74>&#34;/home/myusername/Downloads/tmp/com.yucore.swashbucklerdiary-1.17.0-1-PKGBUILD&#34;</span>
</span></span></code></pre></div><p>This is exactly the behavior we want! The script now correctly creates a new, clean subdirectory within the current
directory to store the <code>PKGBUILD</code> file, without posing any threat to the current directory itself.</p><p>With the release of <code>debtap 3.6.3</code>, this heart-stopping bug was finally squashed.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tategotoazarasi.github.io/en/tags/debtap/>Debtap</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/bug/>Bug</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/rm-rf/>Rm-Rf</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/shell-script/>Shell-Script</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/bash/>Bash</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/arch-linux/>Arch-Linux</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/pkgbuild/>Pkgbuild</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/dirname/>Dirname</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/debugging/>Debugging</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/git/>Git</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/git-blame/>Git-Blame</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/open-source/>Open-Source</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/data-loss/>Data-Loss</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/linux/>Linux</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/command-line/>Command-Line</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/software-development/>Software-Development</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/code-review/>Code-Review</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/typo/>Typo</a></li></ul><nav class=paginav><a class=prev href=https://tategotoazarasi.github.io/en/posts/uol-2025-wk2/><span class=title>« Prev</span><br><span>Uol 2025 Wk2 Solutions</span>
</a><a class=next href=https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/><span class=title>Next »</span><br><span>Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tategotoazarasi.github.io/en/>Tategoto Azarasi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>