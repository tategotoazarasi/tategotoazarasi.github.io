<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux | Tategoto Azarasi</title>
<meta name=keywords content="linux-audio,thinkbook-16-g7-asp,amd-ryzen-ai,dmic-no-sound,digital-microphone-fix,pipewire-troubleshooting,wireplumber-acp-error,alsa-ucm,snd-sof-amd-common,enable-pdm,kernel-module-options,cachyos,arch-linux-audio,amd-acp-audio,sound-open-firmware,sof-firmware,strix-point-apu,linux-laptop-mic-fix,linux,audio,thinkbook,amd,ryzen-ai,dmic,microphone,pipewire,wireplumber,alsa,sof,kernel,troubleshooting,fix,cachyos,arch-linux,laptop"><meta name=description content="Detailed troubleshooting process for fixing a silent digital microphone on a Lenovo ThinkBook 16 G7+ ASP (AMD Ryzen AI 9) laptop running Linux, primarily resolved by adding the kernel module parameter options snd_sof_amd_common enable_pdm=1."><meta name=author content="Tategoto Azarasi"><link rel=canonical href=https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://tategotoazarasi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tategotoazarasi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tategotoazarasi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tategotoazarasi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tategotoazarasi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/><link rel=alternate hreflang=zh href=https://tategotoazarasi.github.io/zh/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR onload=renderMathInElement(document.body) src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js></script>>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/"><meta property="og:site_name" content="Tategoto Azarasi"><meta property="og:title" content="Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux"><meta property="og:description" content="Detailed troubleshooting process for fixing a silent digital microphone on a Lenovo ThinkBook 16 G7+ ASP (AMD Ryzen AI 9) laptop running Linux, primarily resolved by adding the kernel module parameter options snd_sof_amd_common enable_pdm=1."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-24T21:32:30+08:00"><meta property="article:modified_time" content="2025-05-24T21:32:30+08:00"><meta property="article:tag" content="Linux-Audio"><meta property="article:tag" content="Thinkbook-16-G7-Asp"><meta property="article:tag" content="Amd-Ryzen-Ai"><meta property="article:tag" content="Dmic-No-Sound"><meta property="article:tag" content="Digital-Microphone-Fix"><meta property="article:tag" content="Pipewire-Troubleshooting"><meta name=twitter:card content="summary"><meta name=twitter:title content="Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux"><meta name=twitter:description content="Detailed troubleshooting process for fixing a silent digital microphone on a Lenovo ThinkBook 16 G7+ ASP (AMD Ryzen AI 9) laptop running Linux, primarily resolved by adding the kernel module parameter options snd_sof_amd_common enable_pdm=1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tategotoazarasi.github.io/en/posts/"},{"@type":"ListItem","position":2,"name":"Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux","item":"https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux","name":"Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7\u002b ASP with Linux","description":"Detailed troubleshooting process for fixing a silent digital microphone on a Lenovo ThinkBook 16 G7+ ASP (AMD Ryzen AI 9) laptop running Linux, primarily resolved by adding the kernel module parameter options snd_sof_amd_common enable_pdm=1.","keywords":["linux-audio","thinkbook-16-g7-asp","amd-ryzen-ai","dmic-no-sound","digital-microphone-fix","pipewire-troubleshooting","wireplumber-acp-error","alsa-ucm","snd-sof-amd-common","enable-pdm","kernel-module-options","cachyos","arch-linux-audio","amd-acp-audio","sound-open-firmware","sof-firmware","strix-point-apu","linux-laptop-mic-fix","linux","audio","thinkbook","amd","ryzen-ai","dmic","microphone","pipewire","wireplumber","alsa","sof","kernel","troubleshooting","fix","cachyos","arch-linux","laptop"],"articleBody":"It’s a familiar story for many Linux enthusiasts: the thrill of unboxing a shiny new laptop, the eager anticipation of installing your favorite distribution, and then… the little papercuts. Sometimes it’s Wi-Fi, sometimes suspend/resume, and very often, it’s the audio, particularly the microphone. My recent acquisition, a Lenovo ThinkBook 16 G7+ ASP powered by an AMD Ryzen AI 9 365 (part of the “Strix Point” family, for those keeping score), running CachyOS (an Arch-based distribution) with kernel 6.14.8-2-cachyos, decided to give me the silent treatment from its built-in digital microphone array.\nIf you’re facing a similar issue, especially on recent AMD hardware, I hope my odyssey provides some clues, or at least, solidarity.\nIs This Thing On? The first step in any troubleshooting saga is to gather information. What does the system think it has?\nThe Kernel’s Perspective (ALSA) At the lowest level accessible to most user-space tools, we have ALSA (Advanced Linux Sound Architecture). The command arecord -l lists capture hardware devices as ALSA sees them:\n**** List of CAPTURE Hardware Devices **** card 1: Generic_1 [HD-Audio Generic], device 0: ALC257 Analog [ALC257 Analog] Subdevices: 1/1 Subdevice #0: subdevice #0 card 2: acppdmmach [acp-pdm-mach], device 0: DMIC capture dmic-hifi-0 [] Subdevices: 1/1 Subdevice #0: subdevice #0 This was interesting and somewhat promising. The output showed two main entries. The first, card 1: Generic_1 [...] ALC257 Analog, was identified as our standard analog audio codec, a Realtek ALC257. This component would typically handle headphone jacks and, if the laptop had one, an analog microphone input, though many modern devices exclusively use digital arrays. The second entry, card 2: acppdmmach [...] DMIC capture, immediately looked like our target. The “DMIC” clearly stands for Digital Microphone, and “acp-pdm-mach” suggested its connection via AMD’s Audio Co-Processor (ACP) using Pulse Density Modulation (PDM), a common interface for digital microphones. So, ALSA seemed to be aware of a digital microphone. That’s a good start.\nFor completeness, aplay -l shows playback devices:\n**** List of PLAYBACK Hardware Devices **** card 0: Generic [HD-Audio Generic], device 3: HDMI 0 [HDMI 0] ... (other HDMI outputs) ... card 1: Generic_1 [HD-Audio Generic], device 0: ALC257 Analog [ALC257 Analog] Subdevices: 0/1 Subdevice #0: subdevice #0 Card 0 is the HDMI audio output from the AMD GPU, and Card 1 is the analog output via the ALC257 (speakers, headphones). This all seemed normal.\nThe Sound Server’s Perspective (PipeWire) This was interesting and somewhat promising.\nModern Linux desktops predominantly use PipeWire, often with WirePlumber as the session manager, to handle audio and video streams. This system provides compatibility layers for PulseAudio and JACK applications. To understand PipeWire’s perspective, I used the pactl list cards command.\nThe output revealed a couple of important “cards” as seen by PipeWire. The first, Card #42: alsa_card.pci-0000_65_00.1, was named HD-Audio Generic (its alsa.card_name) and more specifically identified by its device.product.name as Rembrandt Radeon High Definition Audio Controller. This clearly corresponded to ALSA’s card 0. It listed various HDMI outputs but, notably, had sources: 0, which is logical as HDMI audio is typically an output-only path.\nThe second entry from PipeWire, Card #43: alsa_card.pci-0000_65_00.6, was also designated as HD-Audio Generic by its alsa.card_name. However, its device.product.name was Family 17h/19h/1ah HD Audio Controller, and its alsa.mixer_name was Realtek ALC257. This card matched ALSA’s card 1. Its active profile was reported as HiFi (Mic1, Mic2, Speaker). Delving into its Ports section, PipeWire listed an [Out] Speaker and an [Out] Headphones port, the latter being not available unless headphones were plugged in. For inputs, it showed an [In] Mic2: Stereo Microphone, possibly associated with the headphone jack and also not available unless a device was connected, and, crucially, an [In] Mic1: Digital Microphone whose availability was marked as unknown.\nThe presence of “Mic1: Digital Microphone” under this ALC257-associated card (Card #43) was initially a bit perplexing. It wasn’t immediately clear if the DMIC was routed through the ALC257 codec or if this was simply how PipeWire and WirePlumber decided to group these functionalities based on ALSA Use Case Manager (UCM) profiles. What stood out was that the acppdmmach device, which ALSA identified as card 2 and the likely candidate for the DMIC, wasn’t directly listed as a distinct top-level “Card” in the pactl list cards output. This was a significant flag, suggesting that while ALSA might expose the device, PipeWire might not be initializing or interpreting it correctly to present it as a fully independent audio card.\nPCI Device Identification To get a clearer picture of the underlying hardware, I used lspci | grep Audio. This command confirmed the audio-related PCI devices present in the system:\n65:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Rembrandt Radeon High Definition Audio Controller 65:00.5 Multimedia controller: Advanced Micro Devices, Inc. [AMD] ACP/ACP3X/ACP6x Audio Coprocessor (rev 70) 65:00.6 Audio device: Advanced Micro Devices, Inc. [AMD] Family 17h/19h/1ah HD Audio Controller The output broke down as follows: the device at PCI address 65:00.1 was identified as the HDMI audio controller, part of the AMD Radeon graphics. The device at 65:00.5 was the AMD Audio Co-Processor (ACP), specifically revision 70; this is the component primarily responsible for handling the digital microphone (DMIC). Finally, the device at 65:00.6 was the analog audio controller, which interfaces with the Realtek ALC257 codec for speakers and headphone jacks. This information aligned perfectly with what arecord -l and pactl list cards were suggesting: the DMIC’s functionality was undeniably tied to the ACP.\nSystem Software Check A quick check of installed packages confirmed I had the usual suspects for a modern Linux audio setup. The core PipeWire stack, including pipewire, pipewire-alsa, pipewire-pulse, and wireplumber, was present. The ALSA essentials, such as alsa-lib, alsa-utils, and alsa-card-profiles, were also installed. Crucially, I had fairly recent versions of the necessary firmware blobs: linux-firmware (version 20250508) and sof-firmware (Sound Open Firmware, version 2025.01.1). The sof-firmware package is particularly important for modern Intel and AMD audio hardware, especially for devices connected via coprocessors like AMD’s ACP.\nAt this stage, the initial reconnaissance suggested that ALSA was aware of a DMIC device. PipeWire seemed to acknowledge a “Digital Microphone” port in its configuration, but it wasn’t entirely clear if this port was properly associated with the ACP’s dedicated acppdmmach device. The hardware components were clearly present, and the core audio software and firmware were installed. Despite all this, the internal microphone remained stubbornly silent.\nLogs and Configurations Time to get our hands dirty with logs and deeper configuration details.\nKernel Messages (dmesg) Initially, I tried sudo dmesg | grep -iE 'acp|dmic|snd_pci_acp|snd_sof_amd' but got no output. This was puzzling. dmesg should always have something. This might have been an artifact of how I was filtering or perhaps the relevant messages had scrolled out of the buffer quickly after boot. I made a mental note to try broader dmesg searches later or check the full journalctl -k. The absence of explicit error messages here was, in itself, a piece of information – no obvious driver crashes or failures to load for these specific terms, at least not that grep caught initially.\nALSA Use Case Manager (UCM) ALSA UCM files describe how devices, ports, and profiles are meant to be used. They are essential for PipeWire/WirePlumber to make sense of complex audio hardware. Since pactl list cards associated “Mic1: Digital Microphone” with Card #43 (ALSA card 1, the ALC257), I dumped its UCM: alsaucm -c hw:1 dump text (where hw:1 refers to ALSA card 1).\nThe output contained this interesting snippet under Verb.HiFi:\nDevice.Mic1 { Comment \"Digital Microphone\" Values { CaptureCTL \"_ucm0001.hw:Generic_1\" CaptureMixerElem \"Mic ACP LED\" CapturePCM \"_ucm0001.hw:acppdmmach\" // BINGO! CapturePriority 100 CaptureSwitch \"Mic ACP LED Capture Switch\" PlaybackCTL \"_ucm0001.hw:Generic_1\" TQ HiFi } } The line CapturePCM \"_ucm0001.hw:acppdmmach\" was key. It explicitly states that the UCM profile’s “Mic1” (Digital Microphone) expects to use the ALSA PCM device named acppdmmach. This device was listed by arecord -l as card 2. So, the UCM config for the ALC257 (card 1) references the ACP’s DMIC (card 2) for its “Digital Microphone” input. This explained why “Digital Microphone” appeared under the ALC257’s card in PipeWire – it was following the UCM logic.\nThis reinforced that acppdmmach needed to be fully functional and correctly interpreted by the higher layers.\nWirePlumber’s Sanity WirePlumber is the session manager that makes many of the decisions about how PipeWire connects things. Its logs are invaluable. journalctl -b --user -u wireplumber revealed the smoking gun:\nMay 24 19:39:01 wangzhiheng wireplumber[1808]: wp-device: SPA handle 'api.alsa.acp.device' could not be loaded; is it installed? May 24 19:39:01 wangzhiheng wireplumber[1808]: s-monitors: Failed to create 'api.alsa.acp.device' device There it was. WirePlumber was explicitly failing to load or create something called api.alsa.acp.device. SPA stands for Simple Plugin API, which PipeWire uses for its plugins. This strongly suggested that WirePlumber, despite ALSA knowing about acppdmmach (card 2), couldn’t properly interface with the ACP device to make its DMIC functionality available as a source.\nOther errors in the WirePlumber log like failed: Object activation aborted were likely downstream consequences of this primary failure. If the ACP device isn’t properly created, linking to/from it will fail.\nThe logs also mentioned: s-monitors-libcamera: PipeWire's libcamera SPA plugin is missing or broken. This was unrelated to the microphone but worth noting for camera troubleshooting later, perhaps. For now, focus on audio.\nI also ran tree /usr/share/wireplumber to understand its configuration structure. There was no /etc/wireplumber override directory on my system, and notably, no 50-alsa-config.lua in the common paths mentioned in some online troubleshooting guides. This meant WirePlumber was likely running with its default configuration scripts found in /usr/share/wireplumber/scripts/ and main config /usr/share/wireplumber/wireplumber.conf. The absence of 50-alsa-config.lua isn’t necessarily an error; modern WirePlumber versions might integrate its logic differently or it might be an optional override file.\nFull PCI Details with Kernel Modules (lspci -nnk) This command is a goldmine, showing PCI devices, their vendor/device IDs, and the kernel driver currently managing them, plus other candidate modules.\nOf course. Here is the revised text in a plaintext paragraph style:\nThe lspci -nnk command, which provides detailed PCI information including the kernel drivers in use, offered the most revealing clues when focused on the Multimedia Controller at 65:00.5. For this specific device, the AMD Audio Co-Processor with revision 70, the system reported:\nSubsystem: Lenovo Device [17aa:38b3] Kernel driver in use: snd_acp_pci Kernel modules: snd_pci_acp3x, snd_rn_pci_acp3x, snd_pci_acp5x, snd_pci_acp6x, snd_acp_pci, snd_rpl_pci_acp6x, snd_pci_ps, snd_sof_amd_renoir, snd_sof_amd_rembrandt, snd_sof_amd_vangogh, snd_sof_amd_acp63, snd_sof_amd_acp70 The line Kernel driver in use: snd_acp_pci confirmed that the generic ACP PCI driver was loaded and correctly bound to the device. However, the Kernel modules line was truly fascinating. This list showed all the kernel modules that the system considered potential handlers for this hardware. It critically included several important SOF (Sound Open Firmware) drivers. Among them was snd_sof_amd_rembrandt, which was logical since my “Strix Point” APU is a successor to the Rembrandt architecture. Most importantly, it listed specific drivers like snd_sof_amd_acp63 and snd_sof_amd_acp70. Since my ACP was identified as rev 70, the snd_sof_amd_acp70 module immediately stood out as a very strong candidate for providing the specialized SOF layer needed to properly operate the DMIC.\nThe other audio devices:\n65:00.1 Audio device [0403]: ...Rembrandt Radeon High Definition Audio Controller [1002:1640] Kernel driver in use: snd_hda_intel (Standard for HDMI audio).\n65:00.6 Audio device [0403]: ...Family 17h/19h/1ah HD Audio Controller [1022:15e3] Kernel driver in use: snd_hda_intel (Standard for analog HDA codecs like the ALC257).\nThis confirmed that the standard drivers were loaded for the HDMI and analog audio parts. The focus remained on the ACP and how snd_acp_pci interacts (or needs to interact) with a SOF DSP driver like snd_sof_amd_acp70 or a more generic snd_sof_amd_common.\nConnecting the Dots Okay, summarizing the clues gathered so far painted a fairly clear picture. First, ALSA, the fundamental sound layer, correctly identified an acppdmmach device as card 2, which was our prime suspect for the digital microphone. Second, the ALSA Use Case Manager (UCM) configuration for the Realtek ALC257’s “Digital Microphone” profile explicitly pointed to this acppdmmach device for its capture PCM. This meant the system intended for that device to be used.\nHowever, a critical issue arose at the PipeWire/WirePlumber level: WirePlumber’s logs showed a failure to load or create an api.alsa.acp.device. This indicated a breakdown in how the higher-level sound server was trying to interface with the ACP hardware. On the hardware and driver side, we knew the ACP hardware (1022:15e2 rev 70) was present and the generic snd_acp_pci kernel driver was loaded and active. Furthermore, the necessary SOF (Sound Open Firmware) firmware was installed, and relevant SOF-related kernel modules, such as snd_sof_amd_acp70, were available on the system.\nThese points strongly suggested that while the basic components were in place, the interaction or initialization sequence between the generic ACP driver (snd_acp_pci) and the more specialized SOF layer needed for the DMIC was not happening correctly, leading to WirePlumber’s inability to properly utilize the ACP device.\nMy hypothesis: The snd_acp_pci driver by itself might not be enough, or it’s not being initialized in a way that fully exposes the PDM/DMIC capabilities to the SOF layer that WirePlumber expects for api.alsa.acp.device. Essentially, the DSP part of the ACP, which handles the DMIC array, might not be “activated” correctly for PipeWire’s consumption.\nThis is a common pattern on newer AMD (and Intel) laptops where DMICs are processed by a dedicated DSP firmware (SOF) running on an audio coprocessor. If this firmware isn’t loaded correctly or the driver isn’t configured to use it for PDM microphones, things go silent.\nThe Fix Many SOF-based drivers, especially for PDM microphones, have module options to enable or configure specific features. A common one is related to enabling PDM microphone support.\nGiven the list of kernel modules from lspci -nnk, particularly snd_sof_amd_acp70, and the existence of a more generic snd_sof_amd_common module that often serves as a wrapper or common codebase for various AMD ACP SoF drivers, I searched for module options related to these.\nA frequently suggested fix for AMD ACP DMIC issues, based on community forums and bug reports, involves using an enable_pdm kernel module option. The main question was, which specific module should this option target? Possibilities included snd_sof_amd_acp70, the more specific SOF driver for my ACP revision; snd_sof_amd_common, which often serves as a common codebase or umbrella for newer AMD platforms before a highly tailored driver is fully mature or mainlined; or even snd_acp_pci itself, though this was less likely as enable_pdm is typically a SOF-specific feature. The prevailing wisdom for recent AMD platforms often points towards using snd_sof_amd_common for enabling PDM microphone support.\nTherefore, the proposed solution was to add this kernel module option. The first step was to create a new configuration file, for instance, by running sudo nano /etc/modprobe.d/99-thinkbook-mic-fix.conf. The 99- prefix can help ensure this configuration is loaded late, although the loading order for simple options lines isn’t usually critical unless there are direct conflicts; the .conf suffix is, however, mandatory for the system to recognize the file.\nInside this new file, the critical line to add was:\noptions snd_sof_amd_common enable_pdm=1 This instruction tells the snd_sof_amd_common kernel module to explicitly enable PDM microphone support when it loads during system startup. The value 1 is equivalent to true for this boolean option.\nAfter saving this configuration file, the next crucial step was to rebuild the initramfs (initial RAM filesystem). Module options can affect how devices are probed very early in the boot process, so updating the initramfs ensures these new options are available at that stage. On Arch-based systems like my CachyOS installation, this is typically done with the command:\nsudo mkinitcpio -P This command rebuilds all preset initramfs images, incorporating the new modprobe configuration.\nFinally, a full reboot of the system was necessary. This allows the kernel to load with the new module option active, potentially changing how the audio hardware is initialized. This approach felt like a strong candidate for a fix because it directly addressed the PDM (Pulse Density Modulation) aspect of the digital microphone array, targeted a relevant SOF module (snd_sof_amd_common), and was a widely reported solution for similar audio problems on AMD hardware.\nVerification After the reboot, it was time for the moment of truth.\nI opened a voice recorder application and spoke into the laptop. And there it was – the input level meter danced! The microphone was working.\nsudo dmesg | grep -Ei 'sof|acp|dmic|snd_sof_amd_common|snd_sof_amd_acp70'\n[ 0.000000] BIOS-e820: [mem 0x0000000009f00000-0x0000000009f37fff] ACPI NVS ... (many ACPI table lines) ... [ 0.411425] ACPI: \\_SB_.PCI0.GPPA.ACP_.PWRS: New power resource // ACP Power Resource defined in ACPI ... [ 5.676187] snd_acp_pci 0000:65:00.5: enabling device (0000 -\u003e 0002) // The snd_acp_pci driver enabling the device. The crucial line here is [ 5.676187] snd_acp_pci 0000:65:00.5: enabling device (0000 -\u003e 0002). This shows the generic ACP PCI driver is indeed initializing the hardware.\nIdeally, what we would hope to see in the dmesg output after a successful SOF-based DMIC initialization, which the enable_pdm=1 option is intended to trigger, are more specific log lines. These might include messages from sof-audio-pci-intel (or its AMD equivalents like snd_sof_amd_common or snd_sof_amd_acp70) indicating that they have successfully probed or initialized the Digital Signal Processor (DSP). We might also look for lines confirming the detection of PDM devices or DMICs by the SOF driver. Furthermore, logs indicating that the acp-pdm-mach ALSA device is now being registered by the SOF layer would be strong evidence of a successful initialization sequence.\nThis troubleshooting journey, specific to a ThinkBook 16 G7+ ASP with an AMD “Strix Point” APU, underscores several common themes in Linux audio problem-solving. The audio stack’s layered complexity, from hardware and kernel drivers ( ALSA, SOF) through the sound server (PipeWire) and session manager (WirePlumber) to applications, means issues can arise at many points of interaction. Consequently, examining logs is paramount: dmesg (or journalctl -k) for kernel messages, and user-level service logs for WirePlumber and PipeWire, are indispensable. Ensuring up-to-date firmware, particularly linux-firmware and sof-firmware, is non-negotiable for modern systems. ALSA UCM files also play a vital role in how PipeWire interprets complex audio devices, and while they can sometimes require patches for new hardware, the UCM seemed correct in this instance. Kernel module parameters, configured via /etc/modprobe.d/, are powerful tools for enabling features or addressing hardware quirks, though finding the correct module and option often necessitates research. The increasing prevalence of dedicated DSPs and audio coprocessors, like AMD’s ACP running SOF firmware for tasks such as DMIC array processing, introduces another layer that must function correctly; the enable_pdm=1 option is a direct result of this architectural shift. Furthermore, ACPI tables significantly influence how the OS discovers and configures hardware, including audio components. Finally, the collective wisdom of the Linux community found in forums, wikis, and bug trackers is an immense resource. If the applied fix, such as options snd_sof_amd_common enable_pdm=1, hadn’t resolved the issue, the next steps would have involved trying the enable_pdm=1 option with a more specific module like snd_sof_amd_acp70, searching for entirely different module options, testing newer kernel versions (as driver support continually improves), checking for BIOS/UEFI updates from the laptop manufacturer, or, as a last resort, filing detailed bug reports with the relevant upstream projects. Given that this ThinkBook model and its APU are quite new, it’s not uncommon for the latest hardware to require such targeted adjustments until broader Linux support fully matures and these configurations become default or are integrated into UCM profiles.\n","wordCount":"3208","inLanguage":"en","datePublished":"2025-05-24T21:32:30+08:00","dateModified":"2025-05-24T21:32:30+08:00","author":{"@type":"Person","name":"Tategoto Azarasi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tategotoazarasi.github.io/en/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/"},"publisher":{"@type":"Organization","name":"Tategoto Azarasi","logo":{"@type":"ImageObject","url":"https://tategotoazarasi.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tategotoazarasi.github.io/en/ accesskey=h title="Tategoto Azarasi (Alt + H)">Tategoto Azarasi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://tategotoazarasi.github.io/zh/ title=中文 aria-label=中文>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://tategotoazarasi.github.io/en/ title=Home><span>Home</span></a></li><li><a href=https://tategotoazarasi.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://tategotoazarasi.github.io/en/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tategotoazarasi.github.io/en/>Home</a>&nbsp;»&nbsp;<a href=https://tategotoazarasi.github.io/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Troubleshooting a Stubborn DMIC on a ThinkBook 16 G7+ ASP with Linux</h1><div class=post-meta><span title='2025-05-24 21:32:30 +0800 +0800'>May 24, 2025</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;3208 words&nbsp;·&nbsp;Tategoto Azarasi&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://tategotoazarasi.github.io/zh/posts/troubleshooting-a-stubborn-dmic-on-a-thinkbook-16-g7-plus-asp-with-linux/>Zh</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ol><li><a href=#is-this-thing-on>Is This Thing On?</a><ol><li><a href=#the-kernels-perspective-alsa>The Kernel&rsquo;s Perspective (ALSA)</a></li><li><a href=#the-sound-servers-perspective-pipewire>The Sound Server&rsquo;s Perspective (PipeWire)</a></li><li><a href=#pci-device-identification>PCI Device Identification</a></li><li><a href=#system-software-check>System Software Check</a></li></ol></li><li><a href=#logs-and-configurations>Logs and Configurations</a><ol><li><a href=#kernel-messages-dmesg>Kernel Messages (dmesg)</a></li><li><a href=#alsa-use-case-manager-ucm>ALSA Use Case Manager (UCM)</a></li><li><a href=#wireplumbers-sanity>WirePlumber&rsquo;s Sanity</a></li><li><a href=#full-pci-details-with-kernel-modules-lspci--nnk>Full PCI Details with Kernel Modules (<code>lspci -nnk</code>)</a></li></ol></li><li><a href=#connecting-the-dots>Connecting the Dots</a></li><li><a href=#the-fix>The Fix</a></li><li><a href=#verification>Verification</a></li></ol></nav></div></details></div><div class=post-content><p>It&rsquo;s a familiar story for many Linux enthusiasts: the thrill of unboxing a shiny new laptop, the eager anticipation of
installing your favorite distribution, and then&mldr; the little papercuts. Sometimes it&rsquo;s Wi-Fi, sometimes suspend/resume,
and very often, it&rsquo;s the audio, particularly the microphone. My recent acquisition, a Lenovo ThinkBook 16 G7+ ASP
powered by an AMD Ryzen AI 9 365 (part of the &ldquo;Strix Point&rdquo; family, for those keeping score), running CachyOS (an
Arch-based distribution) with kernel 6.14.8-2-cachyos, decided to give me the silent treatment from its built-in digital
microphone array.</p><p>If you&rsquo;re facing a similar issue, especially on recent AMD hardware, I hope my odyssey provides some clues, or at least,
solidarity.</p><h2 id=is-this-thing-on>Is This Thing On?<a hidden class=anchor aria-hidden=true href=#is-this-thing-on>#</a></h2><p>The first step in any troubleshooting saga is to gather information. What does the system <em>think</em> it has?</p><h3 id=the-kernels-perspective-alsa>The Kernel&rsquo;s Perspective (ALSA)<a hidden class=anchor aria-hidden=true href=#the-kernels-perspective-alsa>#</a></h3><p>At the lowest level accessible to most user-space tools, we have ALSA (Advanced Linux Sound Architecture). The command
<code>arecord -l</code> lists capture hardware devices as ALSA sees them:</p><pre tabindex=0><code>**** List of CAPTURE Hardware Devices ****
card 1: Generic_1 [HD-Audio Generic], device 0: ALC257 Analog [ALC257 Analog]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 2: acppdmmach [acp-pdm-mach], device 0: DMIC capture dmic-hifi-0 []
  Subdevices: 1/1
  Subdevice #0: subdevice #0
</code></pre><p>This was interesting and somewhat promising. The output showed two main entries. The first,
<code>card 1: Generic_1 [...] ALC257 Analog</code>, was identified as our standard analog audio codec, a Realtek ALC257. This
component would typically handle headphone jacks and, if the laptop had one, an analog microphone input, though many
modern devices exclusively use digital arrays. The second entry, <code>card 2: acppdmmach [...] DMIC capture</code>, immediately
looked like <strong>our target</strong>. The &ldquo;DMIC&rdquo; clearly stands for Digital Microphone, and &ldquo;acp-pdm-mach&rdquo; suggested its
connection via AMD&rsquo;s Audio Co-Processor (ACP) using Pulse Density Modulation (PDM), a common interface for digital
microphones. So, ALSA seemed to be aware of a digital microphone. That&rsquo;s a good start.</p><p>For completeness, <code>aplay -l</code> shows playback devices:</p><pre tabindex=0><code>**** List of PLAYBACK Hardware Devices ****
card 0: Generic [HD-Audio Generic], device 3: HDMI 0 [HDMI 0]
  ... (other HDMI outputs) ...
card 1: Generic_1 [HD-Audio Generic], device 0: ALC257 Analog [ALC257 Analog]
  Subdevices: 0/1
  Subdevice #0: subdevice #0
</code></pre><p>Card 0 is the HDMI audio output from the AMD GPU, and Card 1 is the analog output via the ALC257 (speakers, headphones).
This all seemed normal.</p><h3 id=the-sound-servers-perspective-pipewire>The Sound Server&rsquo;s Perspective (PipeWire)<a hidden class=anchor aria-hidden=true href=#the-sound-servers-perspective-pipewire>#</a></h3><p>This was interesting and somewhat promising.</p><p>Modern Linux desktops predominantly use PipeWire, often with WirePlumber as the session manager, to handle audio and
video streams. This system provides compatibility layers for PulseAudio and JACK applications. To understand PipeWire&rsquo;s
perspective, I used the <code>pactl list cards</code> command.</p><p>The output revealed a couple of important &ldquo;cards&rdquo; as seen by PipeWire. The first,
<code>Card #42: alsa_card.pci-0000_65_00.1</code>, was named <code>HD-Audio Generic</code> (its <code>alsa.card_name</code>) and more specifically
identified by its <code>device.product.name</code> as <code>Rembrandt Radeon High Definition Audio Controller</code>. This clearly
corresponded to ALSA&rsquo;s <code>card 0</code>. It listed various HDMI outputs but, notably, had <code>sources: 0</code>, which is logical as HDMI
audio is typically an output-only path.</p><p>The second entry from PipeWire, <code>Card #43: alsa_card.pci-0000_65_00.6</code>, was also designated as <code>HD-Audio Generic</code> by its
<code>alsa.card_name</code>. However, its <code>device.product.name</code> was <code>Family 17h/19h/1ah HD Audio Controller</code>, and its
<code>alsa.mixer_name</code> was <code>Realtek ALC257</code>. This card matched ALSA&rsquo;s <code>card 1</code>. Its active profile was reported as
<code>HiFi (Mic1, Mic2, Speaker)</code>. Delving into its <code>Ports</code> section, PipeWire listed an <code>[Out] Speaker</code> and an
<code>[Out] Headphones</code> port, the latter being <code>not available</code> unless headphones were plugged in. For inputs, it showed an
<code>[In] Mic2: Stereo Microphone</code>, possibly associated with the headphone jack and also <code>not available</code> unless a device was
connected, and, crucially, an <code>[In] Mic1: Digital Microphone</code> whose availability was marked as <code>unknown</code>.</p><p>The presence of &ldquo;Mic1: Digital Microphone&rdquo; under this ALC257-associated card (Card #43) was initially a bit perplexing.
It wasn&rsquo;t immediately clear if the DMIC was routed <em>through</em> the ALC257 codec or if this was simply how PipeWire and
WirePlumber decided to group these functionalities based on ALSA Use Case Manager (UCM) profiles. What stood out was
that the <code>acppdmmach</code> device, which ALSA identified as <code>card 2</code> and the likely candidate for the DMIC, wasn&rsquo;t directly
listed as a distinct top-level &ldquo;Card&rdquo; in the <code>pactl list cards</code> output. This was a significant flag, suggesting that
while ALSA might expose the device, PipeWire might not be initializing or interpreting it correctly to present it as a
fully independent audio card.</p><h3 id=pci-device-identification>PCI Device Identification<a hidden class=anchor aria-hidden=true href=#pci-device-identification>#</a></h3><p>To get a clearer picture of the underlying hardware, I used <code>lspci | grep Audio</code>. This command confirmed the
audio-related PCI devices present in the system:</p><pre tabindex=0><code>65:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Rembrandt Radeon High Definition Audio Controller
65:00.5 Multimedia controller: Advanced Micro Devices, Inc. [AMD] ACP/ACP3X/ACP6x Audio Coprocessor (rev 70)
65:00.6 Audio device: Advanced Micro Devices, Inc. [AMD] Family 17h/19h/1ah HD Audio Controller
</code></pre><p>The output broke down as follows: the device at PCI address <code>65:00.1</code> was identified as the HDMI audio controller, part
of the AMD Radeon graphics. The device at <code>65:00.5</code> was the AMD Audio Co-Processor (ACP), specifically revision 70; this
is the component primarily responsible for handling the digital microphone (DMIC). Finally, the device at <code>65:00.6</code> was
the analog audio controller, which interfaces with the Realtek ALC257 codec for speakers and headphone jacks. This
information aligned perfectly with what <code>arecord -l</code> and <code>pactl list cards</code> were suggesting: the DMIC&rsquo;s functionality
was undeniably tied to the ACP.</p><h3 id=system-software-check>System Software Check<a hidden class=anchor aria-hidden=true href=#system-software-check>#</a></h3><p>A quick check of installed packages confirmed I had the usual suspects for a modern Linux audio setup. The core PipeWire
stack, including <code>pipewire</code>, <code>pipewire-alsa</code>, <code>pipewire-pulse</code>, and <code>wireplumber</code>, was present. The ALSA essentials,
such as <code>alsa-lib</code>, <code>alsa-utils</code>, and <code>alsa-card-profiles</code>, were also installed. Crucially, I had fairly recent versions
of the necessary firmware blobs: <code>linux-firmware</code> (version 20250508) and <code>sof-firmware</code> (Sound Open Firmware, version
2025.01.1). The <code>sof-firmware</code> package is particularly important for modern Intel and AMD audio hardware, especially for
devices connected via coprocessors like AMD&rsquo;s ACP.</p><p>At this stage, the initial reconnaissance suggested that ALSA was aware of a DMIC device. PipeWire seemed to acknowledge
a &ldquo;Digital Microphone&rdquo; port in its configuration, but it wasn&rsquo;t entirely clear if this port was properly associated with
the ACP&rsquo;s dedicated <code>acppdmmach</code> device. The hardware components were clearly present, and the core audio software and
firmware were installed. Despite all this, the internal microphone remained stubbornly silent.</p><h2 id=logs-and-configurations>Logs and Configurations<a hidden class=anchor aria-hidden=true href=#logs-and-configurations>#</a></h2><p>Time to get our hands dirty with logs and deeper configuration details.</p><h3 id=kernel-messages-dmesg>Kernel Messages (dmesg)<a hidden class=anchor aria-hidden=true href=#kernel-messages-dmesg>#</a></h3><p>Initially, I tried <code>sudo dmesg | grep -iE 'acp|dmic|snd_pci_acp|snd_sof_amd'</code> but got no output. This was puzzling.
<code>dmesg</code> should always have <em>something</em>. This might have been an artifact of how I was filtering or perhaps the relevant
messages had scrolled out of the buffer quickly after boot. I made a mental note to try broader <code>dmesg</code> searches later
or check the full <code>journalctl -k</code>. The <em>absence</em> of explicit error messages here was, in itself, a piece of
information – no obvious driver crashes or failures to load for these specific terms, at least not that <code>grep</code> caught
initially.</p><h3 id=alsa-use-case-manager-ucm>ALSA Use Case Manager (UCM)<a hidden class=anchor aria-hidden=true href=#alsa-use-case-manager-ucm>#</a></h3><p>ALSA UCM files describe how devices, ports, and profiles are meant to be used. They are essential for
PipeWire/WirePlumber to make sense of complex audio hardware.
Since <code>pactl list cards</code> associated &ldquo;Mic1: Digital Microphone&rdquo; with Card #43 (ALSA card 1, the ALC257), I dumped its
UCM:
<code>alsaucm -c hw:1 dump text</code> (where <code>hw:1</code> refers to ALSA card 1).</p><p>The output contained this interesting snippet under <code>Verb.HiFi</code>:</p><pre tabindex=0><code>Device.Mic1 {
        Comment &#34;Digital Microphone&#34;
        Values {
                CaptureCTL &#34;_ucm0001.hw:Generic_1&#34;
                CaptureMixerElem &#34;Mic ACP LED&#34;
                CapturePCM &#34;_ucm0001.hw:acppdmmach&#34;  // BINGO!
                CapturePriority 100
                CaptureSwitch &#34;Mic ACP LED Capture Switch&#34;
                PlaybackCTL &#34;_ucm0001.hw:Generic_1&#34;
                TQ HiFi
        }
}
</code></pre><p>The line <code>CapturePCM "_ucm0001.hw:acppdmmach"</code> was key. It explicitly states that the UCM profile&rsquo;s &ldquo;Mic1&rdquo; (Digital
Microphone) expects to use the ALSA PCM device named <code>acppdmmach</code>. This device was listed by <code>arecord -l</code> as <code>card 2</code>.
So, the UCM config for the ALC257 (card 1) <em>references</em> the ACP&rsquo;s DMIC (card 2) for its &ldquo;Digital Microphone&rdquo; input. This
explained why &ldquo;Digital Microphone&rdquo; appeared under the ALC257&rsquo;s card in PipeWire – it was following the UCM logic.</p><p>This reinforced that <code>acppdmmach</code> needed to be fully functional and correctly interpreted by the higher layers.</p><h3 id=wireplumbers-sanity>WirePlumber&rsquo;s Sanity<a hidden class=anchor aria-hidden=true href=#wireplumbers-sanity>#</a></h3><p>WirePlumber is the session manager that makes many of the decisions about how PipeWire connects things. Its logs are
invaluable.
<code>journalctl -b --user -u wireplumber</code> revealed the smoking gun:</p><pre tabindex=0><code>May 24 19:39:01 wangzhiheng wireplumber[1808]: wp-device: SPA handle &#39;api.alsa.acp.device&#39; could not be loaded; is it installed?
May 24 19:39:01 wangzhiheng wireplumber[1808]: s-monitors: Failed to create &#39;api.alsa.acp.device&#39; device
</code></pre><p>There it was. WirePlumber was explicitly failing to load or create something called <code>api.alsa.acp.device</code>. SPA stands
for Simple Plugin API, which PipeWire uses for its plugins. This strongly suggested that WirePlumber, despite ALSA
knowing about <code>acppdmmach</code> (card 2), couldn&rsquo;t properly interface with the ACP device to make its DMIC functionality
available as a source.</p><p>Other errors in the WirePlumber log like
<code>&lt;WpAsyncEventHook:0x64962e406260> failed: &lt;WpSiStandardLink:0x64962e7914f0> Object activation aborted</code> were likely
downstream consequences of this primary failure. If the ACP device isn&rsquo;t properly created, linking to/from it will fail.</p><p>The logs also mentioned:
<code>s-monitors-libcamera: PipeWire's libcamera SPA plugin is missing or broken.</code>
This was unrelated to the microphone but worth noting for camera troubleshooting later, perhaps. For now, focus on
audio.</p><p>I also ran <code>tree /usr/share/wireplumber</code> to understand its configuration structure. There was no <code>/etc/wireplumber</code>
override directory on my system, and notably, no <code>50-alsa-config.lua</code> in the common paths mentioned in some online
troubleshooting guides. This meant WirePlumber was likely running with its default configuration scripts found in
<code>/usr/share/wireplumber/scripts/</code> and main config <code>/usr/share/wireplumber/wireplumber.conf</code>. The absence of
<code>50-alsa-config.lua</code> isn&rsquo;t necessarily an error; modern WirePlumber versions might integrate its logic differently or it
might be an optional override file.</p><h3 id=full-pci-details-with-kernel-modules-lspci--nnk>Full PCI Details with Kernel Modules (<code>lspci -nnk</code>)<a hidden class=anchor aria-hidden=true href=#full-pci-details-with-kernel-modules-lspci--nnk>#</a></h3><p>This command is a goldmine, showing PCI devices, their vendor/device IDs, and the kernel driver currently managing them,
plus other candidate modules.</p><p>Of course. Here is the revised text in a plaintext paragraph style:</p><p>The <code>lspci -nnk</code> command, which provides detailed PCI information including the kernel drivers in use, offered the most
revealing clues when focused on the Multimedia Controller at <code>65:00.5</code>. For this specific device, the AMD Audio
Co-Processor with revision 70, the system reported:</p><pre tabindex=0><code>Subsystem: Lenovo Device [17aa:38b3]
Kernel driver in use: snd_acp_pci
Kernel modules: snd_pci_acp3x, snd_rn_pci_acp3x, snd_pci_acp5x, snd_pci_acp6x, snd_acp_pci, snd_rpl_pci_acp6x, snd_pci_ps, snd_sof_amd_renoir, snd_sof_amd_rembrandt, snd_sof_amd_vangogh, snd_sof_amd_acp63, snd_sof_amd_acp70
</code></pre><p>The line <code>Kernel driver in use: snd_acp_pci</code> confirmed that the generic ACP PCI driver was loaded and correctly bound to
the device. However, the <code>Kernel modules</code> line was truly fascinating. This list showed all the kernel modules that the
system considered potential handlers for this hardware. It critically included several important SOF (Sound Open
Firmware) drivers. Among them was <code>snd_sof_amd_rembrandt</code>, which was logical since my &ldquo;Strix Point&rdquo; APU is a successor
to the Rembrandt architecture. Most importantly, it listed specific drivers like <code>snd_sof_amd_acp63</code> and
<code>snd_sof_amd_acp70</code>. Since my ACP was identified as <code>rev 70</code>, the <code>snd_sof_amd_acp70</code> module immediately stood out as a
very strong candidate for providing the specialized SOF layer needed to properly operate the DMIC.</p><p>The other audio devices:</p><p><code>65:00.1 Audio device [0403]: ...Rembrandt Radeon High Definition Audio Controller [1002:1640]</code>
<code>Kernel driver in use: snd_hda_intel</code> (Standard for HDMI audio).</p><p><code>65:00.6 Audio device [0403]: ...Family 17h/19h/1ah HD Audio Controller [1022:15e3]</code>
<code>Kernel driver in use: snd_hda_intel</code> (Standard for analog HDA codecs like the ALC257).</p><p>This confirmed that the standard drivers were loaded for the HDMI and analog audio parts. The focus remained on the ACP
and how <code>snd_acp_pci</code> interacts (or needs to interact) with a SOF DSP driver like <code>snd_sof_amd_acp70</code> or a more generic
<code>snd_sof_amd_common</code>.</p><h2 id=connecting-the-dots>Connecting the Dots<a hidden class=anchor aria-hidden=true href=#connecting-the-dots>#</a></h2><p>Okay, summarizing the clues gathered so far painted a fairly clear picture. First, ALSA, the fundamental sound layer,
correctly identified an <code>acppdmmach</code> device as <code>card 2</code>, which was our prime suspect for the digital microphone. Second,
the ALSA Use Case Manager (UCM) configuration for the Realtek ALC257&rsquo;s &ldquo;Digital Microphone&rdquo; profile explicitly pointed
to this <code>acppdmmach</code> device for its capture PCM. This meant the system <em>intended</em> for that device to be used.</p><p>However, a critical issue arose at the PipeWire/WirePlumber level: WirePlumber&rsquo;s logs showed a failure to load or create
an <code>api.alsa.acp.device</code>. This indicated a breakdown in how the higher-level sound server was trying to interface with
the ACP hardware. On the hardware and driver side, we knew the ACP hardware (<code>1022:15e2 rev 70</code>) was present and the
generic <code>snd_acp_pci</code> kernel driver was loaded and active. Furthermore, the necessary SOF (Sound Open Firmware) firmware
was installed, and relevant SOF-related kernel modules, such as <code>snd_sof_amd_acp70</code>, were available on the system.</p><p>These points strongly suggested that while the basic components were in place, the interaction or initialization
sequence between the generic ACP driver (<code>snd_acp_pci</code>) and the more specialized SOF layer needed for the DMIC was not
happening correctly, leading to WirePlumber&rsquo;s inability to properly utilize the ACP device.</p><p>My hypothesis: The <code>snd_acp_pci</code> driver by itself might not be enough, or it&rsquo;s not being initialized in a way that fully
exposes the PDM/DMIC capabilities to the SOF layer that WirePlumber expects for <code>api.alsa.acp.device</code>. Essentially, the
DSP part of the ACP, which handles the DMIC array, might not be &ldquo;activated&rdquo; correctly for PipeWire&rsquo;s consumption.</p><p>This is a common pattern on newer AMD (and Intel) laptops where DMICs are processed by a dedicated DSP firmware (SOF)
running on an audio coprocessor. If this firmware isn&rsquo;t loaded correctly or the driver isn&rsquo;t configured to use it for
PDM microphones, things go silent.</p><h2 id=the-fix>The Fix<a hidden class=anchor aria-hidden=true href=#the-fix>#</a></h2><p>Many SOF-based drivers, especially for PDM microphones, have module options to enable or configure specific features. A
common one is related to enabling PDM microphone support.</p><p>Given the list of kernel modules from <code>lspci -nnk</code>, particularly <code>snd_sof_amd_acp70</code>, and the existence of a more
generic <code>snd_sof_amd_common</code> module that often serves as a wrapper or common codebase for various AMD ACP SoF drivers, I
searched for module options related to these.</p><p>A frequently suggested fix for AMD ACP DMIC issues, based on community forums and bug reports, involves using an
<code>enable_pdm</code> kernel module option. The main question was, which specific module should this option target? Possibilities
included <code>snd_sof_amd_acp70</code>, the more specific SOF driver for my ACP revision; <code>snd_sof_amd_common</code>, which often serves
as a common codebase or umbrella for newer AMD platforms before a highly tailored driver is fully mature or mainlined;
or even <code>snd_acp_pci</code> itself, though this was less likely as <code>enable_pdm</code> is typically a SOF-specific feature. The
prevailing wisdom for recent AMD platforms often points towards using <code>snd_sof_amd_common</code> for enabling PDM microphone
support.</p><p>Therefore, the proposed solution was to add this kernel module option. The first step was to create a new configuration
file, for instance, by running <code>sudo nano /etc/modprobe.d/99-thinkbook-mic-fix.conf</code>. The <code>99-</code> prefix can help ensure
this configuration is loaded late, although the loading order for simple <code>options</code> lines isn&rsquo;t usually critical unless
there are direct conflicts; the <code>.conf</code> suffix is, however, mandatory for the system to recognize the file.</p><p>Inside this new file, the critical line to add was:</p><pre tabindex=0><code>options snd_sof_amd_common enable_pdm=1
</code></pre><p>This instruction tells the <code>snd_sof_amd_common</code> kernel module to explicitly enable PDM microphone support when it loads
during system startup. The value <code>1</code> is equivalent to <code>true</code> for this boolean option.</p><p>After saving this configuration file, the next crucial step was to rebuild the initramfs (initial RAM filesystem).
Module options can affect how devices are probed very early in the boot process, so updating the initramfs ensures these
new options are available at that stage. On Arch-based systems like my CachyOS installation, this is typically done with
the command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkinitcpio -P
</span></span></code></pre></div><p>This command rebuilds all preset initramfs images, incorporating the new modprobe configuration.</p><p>Finally, a full <strong>reboot of the system</strong> was necessary. This allows the kernel to load with the new module option
active, potentially changing how the audio hardware is initialized. This approach felt like a strong candidate for a fix
because it directly addressed the PDM (Pulse Density Modulation) aspect of the digital microphone array, targeted a
relevant SOF module (<code>snd_sof_amd_common</code>), and was a widely reported solution for similar audio problems on AMD
hardware.</p><h2 id=verification>Verification<a hidden class=anchor aria-hidden=true href=#verification>#</a></h2><p>After the reboot, it was time for the moment of truth.</p><p>I opened a voice recorder application and spoke into the laptop. And there it was – the input level meter danced! The
microphone was working.</p><p><code>sudo dmesg | grep -Ei 'sof|acp|dmic|snd_sof_amd_common|snd_sof_amd_acp70'</code></p><pre tabindex=0><code>[    0.000000] BIOS-e820: [mem 0x0000000009f00000-0x0000000009f37fff] ACPI NVS
... (many ACPI table lines) ...
[    0.411425] ACPI: \_SB_.PCI0.GPPA.ACP_.PWRS: New power resource  // ACP Power Resource defined in ACPI
...
[    5.676187] snd_acp_pci 0000:65:00.5: enabling device (0000 -&gt; 0002) // The snd_acp_pci driver enabling the device.
</code></pre><p>The crucial line here is <code>[ 5.676187] snd_acp_pci 0000:65:00.5: enabling device (0000 -> 0002)</code>. This shows the generic
ACP PCI driver is indeed initializing the hardware.</p><p>Ideally, what we <em>would hope</em> to see in the <code>dmesg</code> output after a successful SOF-based DMIC initialization, which the
<code>enable_pdm=1</code> option is intended to trigger, are more specific log lines. These might include messages from
<code>sof-audio-pci-intel</code> (or its AMD equivalents like <code>snd_sof_amd_common</code> or <code>snd_sof_amd_acp70</code>) indicating that they
have successfully probed or initialized the Digital Signal Processor (DSP). We might also look for lines confirming the
detection of PDM devices or DMICs by the SOF driver. Furthermore, logs indicating that the <code>acp-pdm-mach</code> ALSA device is
now being registered by the SOF layer would be strong evidence of a successful initialization sequence.</p><p>This troubleshooting journey, specific to a ThinkBook 16 G7+ ASP with an AMD &ldquo;Strix Point&rdquo; APU, underscores several
common themes in Linux audio problem-solving. The audio stack&rsquo;s layered complexity, from hardware and kernel drivers (
ALSA, SOF) through the sound server (PipeWire) and session manager (WirePlumber) to applications, means issues can arise
at many points of interaction. Consequently, examining logs is paramount: <code>dmesg</code> (or <code>journalctl -k</code>) for kernel
messages, and user-level service logs for WirePlumber and PipeWire, are indispensable. Ensuring up-to-date firmware,
particularly <code>linux-firmware</code> and <code>sof-firmware</code>, is non-negotiable for modern systems. ALSA UCM files also play a vital
role in how PipeWire interprets complex audio devices, and while they can sometimes require patches for new hardware,
the UCM seemed correct in this instance. Kernel module parameters, configured via <code>/etc/modprobe.d/</code>, are powerful tools
for enabling features or addressing hardware quirks, though finding the correct module and option often necessitates
research. The increasing prevalence of dedicated DSPs and audio coprocessors, like AMD&rsquo;s ACP running SOF firmware for
tasks such as DMIC array processing, introduces another layer that must function correctly; the <code>enable_pdm=1</code> option is
a direct result of this architectural shift. Furthermore, ACPI tables significantly influence how the OS discovers and
configures hardware, including audio components. Finally, the collective wisdom of the Linux community found in forums,
wikis, and bug trackers is an immense resource. If the applied fix, such as <code>options snd_sof_amd_common enable_pdm=1</code>,
hadn&rsquo;t resolved the issue, the next steps would have involved trying the <code>enable_pdm=1</code> option with a more specific
module like <code>snd_sof_amd_acp70</code>, searching for entirely different module options, testing newer kernel versions (as
driver support continually improves), checking for BIOS/UEFI updates from the laptop manufacturer, or, as a last resort,
filing detailed bug reports with the relevant upstream projects. Given that this ThinkBook model and its APU are quite
new, it&rsquo;s not uncommon for the latest hardware to require such targeted adjustments until broader Linux support fully
matures and these configurations become default or are integrated into UCM profiles.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tategotoazarasi.github.io/en/tags/linux-audio/>Linux-Audio</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/thinkbook-16-g7-asp/>Thinkbook-16-G7-Asp</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/amd-ryzen-ai/>Amd-Ryzen-Ai</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/dmic-no-sound/>Dmic-No-Sound</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/digital-microphone-fix/>Digital-Microphone-Fix</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/pipewire-troubleshooting/>Pipewire-Troubleshooting</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/wireplumber-acp-error/>Wireplumber-Acp-Error</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/alsa-ucm/>Alsa-Ucm</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/snd-sof-amd-common/>Snd-Sof-Amd-Common</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/enable-pdm/>Enable-Pdm</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/kernel-module-options/>Kernel-Module-Options</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/arch-linux-audio/>Arch-Linux-Audio</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/amd-acp-audio/>Amd-Acp-Audio</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/sound-open-firmware/>Sound-Open-Firmware</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/sof-firmware/>Sof-Firmware</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/strix-point-apu/>Strix-Point-Apu</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/linux-laptop-mic-fix/>Linux-Laptop-Mic-Fix</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/linux/>Linux</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/audio/>Audio</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/thinkbook/>Thinkbook</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/amd/>Amd</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/ryzen-ai/>Ryzen-Ai</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/dmic/>Dmic</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/microphone/>Microphone</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/pipewire/>Pipewire</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/wireplumber/>Wireplumber</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/alsa/>Alsa</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/sof/>Sof</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/kernel/>Kernel</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/troubleshooting/>Troubleshooting</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/fix/>Fix</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/cachyos/>Cachyos</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/arch-linux/>Arch-Linux</a></li><li><a href=https://tategotoazarasi.github.io/en/tags/laptop/>Laptop</a></li></ul><nav class=paginav><a class=next href=https://tategotoazarasi.github.io/en/posts/delving-into-anki-cards-demystifying-templates-for-data-extraction-and-practical-application/><span class=title>Next »</span><br><span>Delving into Anki Cards: Demystifying Templates for Data Extraction and Practical Application</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tategotoazarasi.github.io/en/>Tategoto Azarasi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>