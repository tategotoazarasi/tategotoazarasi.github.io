<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://tategotoazarasi.github.io/js/theme-mode.js></script><link rel=stylesheet href=https://tategotoazarasi.github.io/css/frameworks.min.css><link rel=stylesheet href=https://tategotoazarasi.github.io/css/github.min.css><link rel=stylesheet href=https://tategotoazarasi.github.io/css/github-style.css><link rel=stylesheet href=https://tategotoazarasi.github.io/css/light.css><link rel=stylesheet href=https://tategotoazarasi.github.io/css/dark.css><link rel=stylesheet href=https://tategotoazarasi.github.io/css/syntax.css><title>LeetCode 262. Trips and Users - Harp Seal Pup Nursery and Caring Center</title>
<link rel=icon type=image/x-icon href=/images/github.png><meta name=theme-color content="#1e2327"><meta name=description content="Table: Trips
Column Name Type id int client_id int driver_id int city_id int status enum request_at date id is the primary key for this table. The table holds all taxi trips. Each trip has a unique id, while client_id and driver_id are foreign keys to the users_id at the Users table. Status is an ENUM type of (&amp;lsquo;completed&amp;rsquo;, &amp;lsquo;cancelled_by_driver&amp;rsquo;, &amp;lsquo;cancelled_by_client&amp;rsquo;).
Table: Users
Column Name Type users_id int banned enum role enum users_id is the primary key for this table. The table holds all users. Each user has a unique users_id, and role is an ENUM type of (&amp;lsquo;client&amp;rsquo;, &amp;lsquo;driver&amp;rsquo;, &amp;lsquo;partner&amp;rsquo;). banned is an ENUM type of (&amp;lsquo;Yes&amp;rsquo;, &amp;lsquo;No&amp;rsquo;).
The cancellation rate is computed by dividing the number of canceled (by client or driver) requests with unbanned users by the total number of requests with unbanned users on that day.
Write a SQL query to find the cancellation rate of requests with unbanned users (both client and driver must not be banned) each day between &amp;quot;2013-10-01&amp;quot; and &amp;quot;2013-10-03&amp;quot;. Round Cancellation Rate to two decimal points.
Return the result table in any order.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://tategotoazarasi.github.io/post/trips-and-users/><meta name=twitter:card content="summary"><meta name=twitter:title content="LeetCode 262. Trips and Users - Harp Seal Pup Nursery and Caring Center"><meta name=twitter:description content="Table: Trips
Column Name Type id int client_id int driver_id int city_id int status enum request_at date id is the primary key for this table. The table holds all taxi trips. Each trip has a unique id, while client_id and driver_id are foreign keys to the users_id at the Users table. Status is an ENUM type of (&amp;lsquo;completed&amp;rsquo;, &amp;lsquo;cancelled_by_driver&amp;rsquo;, &amp;lsquo;cancelled_by_client&amp;rsquo;).
Table: Users
Column Name Type users_id int banned enum role enum users_id is the primary key for this table. The table holds all users. Each user has a unique users_id, and role is an ENUM type of (&amp;lsquo;client&amp;rsquo;, &amp;lsquo;driver&amp;rsquo;, &amp;lsquo;partner&amp;rsquo;). banned is an ENUM type of (&amp;lsquo;Yes&amp;rsquo;, &amp;lsquo;No&amp;rsquo;).
The cancellation rate is computed by dividing the number of canceled (by client or driver) requests with unbanned users by the total number of requests with unbanned users on that day.
Write a SQL query to find the cancellation rate of requests with unbanned users (both client and driver must not be banned) each day between &amp;quot;2013-10-01&amp;quot; and &amp;quot;2013-10-03&amp;quot;. Round Cancellation Rate to two decimal points.
Return the result table in any order.
"><meta name=twitter:site content="https://tategotoazarasi.github.io/"><meta name=twitter:creator content><meta name=twitter:image content="https://tategotoazarasi.github.io/"><meta property="og:type" content="article"><meta property="og:title" content="LeetCode 262. Trips and Users - Harp Seal Pup Nursery and Caring Center"><meta property="og:description" content="Table: Trips
Column Name Type id int client_id int driver_id int city_id int status enum request_at date id is the primary key for this table. The table holds all taxi trips. Each trip has a unique id, while client_id and driver_id are foreign keys to the users_id at the Users table. Status is an ENUM type of (&amp;lsquo;completed&amp;rsquo;, &amp;lsquo;cancelled_by_driver&amp;rsquo;, &amp;lsquo;cancelled_by_client&amp;rsquo;).
Table: Users
Column Name Type users_id int banned enum role enum users_id is the primary key for this table. The table holds all users. Each user has a unique users_id, and role is an ENUM type of (&amp;lsquo;client&amp;rsquo;, &amp;lsquo;driver&amp;rsquo;, &amp;lsquo;partner&amp;rsquo;). banned is an ENUM type of (&amp;lsquo;Yes&amp;rsquo;, &amp;lsquo;No&amp;rsquo;).
The cancellation rate is computed by dividing the number of canceled (by client or driver) requests with unbanned users by the total number of requests with unbanned users on that day.
Write a SQL query to find the cancellation rate of requests with unbanned users (both client and driver must not be banned) each day between &amp;quot;2013-10-01&amp;quot; and &amp;quot;2013-10-03&amp;quot;. Round Cancellation Rate to two decimal points.
Return the result table in any order.
"><meta property="og:url" content="https://tategotoazarasi.github.io/post/trips-and-users/"><meta property="og:site_name" content="LeetCode 262. Trips and Users"><meta property="og:image" content="https://tategotoazarasi.github.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-02-11 11:04:37 +0800 +0800"></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://tategotoazarasi.github.io/><img class=octicon height=32 width=32 src></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'>
<img height=24 class="octicon octicon-three-bars" width=24 src></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=UTF-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://tategotoazarasi.github.io/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://tategotoazarasi.github.io/><img class="octicon octicon-mark-github v-align-middle" height=32 width=32 src></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://tategotoazarasi.github.io/><img class=avatar-user src=/images/myavatar.webp width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://tategotoazarasi.github.io/>azarasi</a>
</span><span class=path-divider>/</span>
<strong class="css-truncate css-truncate-target mr-1" style=max-width:410px><a href=https://tategotoazarasi.github.io/post/trips-and-users/>LeetCode 262. Trips and Users</a></strong></h1><div class="note m-0">Created <relative-time datetime="Fri, 11 Feb 2022 11:04:37 +0800" class=no-wrap>Fri, 11 Feb 2022 11:04:37 +0800</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Tue, 14 May 2024 06:31:39 +0000" class=no-wrap>Tue, 14 May 2024 06:31:39 +0000</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>1913 Words</div><div class="file-actions flex-order-2 pt-0"><a class="muted-link mr-3" href=/tags/leetcode><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>
leetcode
</a><a class="muted-link mr-3" href=/tags/%E5%9B%B0%E9%9A%BE><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>
困难
</a><a class="muted-link mr-3" href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>
数据库</a></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>Table: <code>Trips</code></p><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>id</td><td>int</td></tr><tr><td>client_id</td><td>int</td></tr><tr><td>driver_id</td><td>int</td></tr><tr><td>city_id</td><td>int</td></tr><tr><td>status</td><td>enum</td></tr><tr><td>request_at</td><td>date</td></tr></tbody></table><p>id is the primary key for this table.
The table holds all taxi trips. Each trip has a unique id, while client_id and driver_id are foreign keys to the users_id at the Users table.
Status is an ENUM type of (&lsquo;completed&rsquo;, &lsquo;cancelled_by_driver&rsquo;, &lsquo;cancelled_by_client&rsquo;).</p><p>Table: <code>Users</code></p><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>users_id</td><td>int</td></tr><tr><td>banned</td><td>enum</td></tr><tr><td>role</td><td>enum</td></tr></tbody></table><p>users_id is the primary key for this table.
The table holds all users. Each user has a unique users_id, and role is an ENUM type of (&lsquo;client&rsquo;, &lsquo;driver&rsquo;, &lsquo;partner&rsquo;).
banned is an ENUM type of (&lsquo;Yes&rsquo;, &lsquo;No&rsquo;).</p><p>The <strong>cancellation rate</strong> is computed by dividing the
number of canceled (by client or driver) requests with unbanned users by
the total number of requests with unbanned users on that day.</p><p>Write a SQL query to find the <strong>cancellation rate</strong> of requests with unbanned users (<strong>both client and driver must not be banned</strong>) each day between <code>"2013-10-01"</code> and <code>"2013-10-03"</code>. Round <code>Cancellation Rate</code> to <strong>two decimal</strong> points.</p><p>Return the result table in <strong>any order</strong>.</p><p>The query result format is in the following example.</p><p><strong>Example 1:</strong></p><p><strong>Input:</strong>
Trips table:</p><table><thead><tr><th>id</th><th>client_id</th><th>driver_id</th><th>city_id</th><th>status</th><th>request_at</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-01</td></tr><tr><td>2</td><td>2</td><td>11</td><td>1</td><td>cancelled_by_driver</td><td>2013-10-01</td></tr><tr><td>3</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-01</td></tr><tr><td>4</td><td>4</td><td>13</td><td>6</td><td>cancelled_by_client</td><td>2013-10-01</td></tr><tr><td>5</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-02</td></tr><tr><td>6</td><td>2</td><td>11</td><td>6</td><td>completed</td><td>2013-10-02</td></tr><tr><td>7</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-02</td></tr><tr><td>8</td><td>2</td><td>12</td><td>12</td><td>completed</td><td>2013-10-03</td></tr><tr><td>9</td><td>3</td><td>10</td><td>12</td><td>completed</td><td>2013-10-03</td></tr><tr><td>10</td><td>4</td><td>13</td><td>12</td><td>cancelled_by_driver</td><td>2013-10-03</td></tr></tbody></table><p>Users table:</p><table><thead><tr><th>users_id</th><th>banned</th><th>role</th></tr></thead><tbody><tr><td>1</td><td>No</td><td>client</td></tr><tr><td>2</td><td>Yes</td><td>client</td></tr><tr><td>3</td><td>No</td><td>client</td></tr><tr><td>4</td><td>No</td><td>client</td></tr><tr><td>10</td><td>No</td><td>driver</td></tr><tr><td>11</td><td>No</td><td>driver</td></tr><tr><td>12</td><td>No</td><td>driver</td></tr><tr><td>13</td><td>No</td><td>driver</td></tr></tbody></table><p><strong>Output:</strong></p><table><thead><tr><th>Day</th><th>Cancellation Rate</th></tr></thead><tbody><tr><td>2013-10-01</td><td>0.33</td></tr><tr><td>2013-10-02</td><td>0.00</td></tr><tr><td>2013-10-03</td><td>0.50</td></tr></tbody></table><p><strong>Explanation:</strong>
On 2013-10-01:</p><ul><li>There were 4 requests in total, 2 of which were canceled.</li><li>However, the request with Id=2 was made by a banned client (User_Id=2), so it is ignored in the calculation.</li><li>Hence there are 3 unbanned requests in total, 1 of which was canceled.</li><li>The Cancellation Rate is (1 / 3) = 0.33
On 2013-10-02:</li><li>There were 3 requests in total, 0 of which were canceled.</li><li>The request with Id=6 was made by a banned client, so it is ignored.</li><li>Hence there are 2 unbanned requests in total, 0 of which were canceled.</li><li>The Cancellation Rate is (0 / 2) = 0.00
On 2013-10-03:</li><li>There were 3 requests in total, 1 of which was canceled.</li><li>The request with Id=8 was made by a banned client, so it is ignored.</li><li>Hence there are 2 unbanned request in total, 1 of which were canceled.</li><li>The Cancellation Rate is (1 / 2) = 0.50</li></ul><h2 id=solution>Solution</h2><p>统计每天非禁止用户的取消率，需要知道非禁止用户有哪些，总行程数，取消的行程数。</p><h3 id=解法一>解法一</h3><p>首先确定被禁止用户的行程记录，再剔除这些行程记录。</p><p>行程表中，字段 client_id 和 driver_id，都与用户表中的 users_id 关联。因此只要 client_id 和 driver_id 中有一个被禁止了，此条行程记录要被剔除。</p><p>先说一种错误的找出没被禁止用户行程记录的方法。此方法很有迷惑性。</p><p>思路：</p><pre tabindex=0><code>if (client_id = users_id 或 driver_id = users_id) 且 users_id没有被禁止
{
    此条记录没被禁止。
}
</code></pre><p>SQL 代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>U</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>client_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>OR</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>driver_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>U</span><span class=p>.</span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>乍一看，思路是对。其实是错误的。因为，我们不知觉得肯定了一个假设—— client_id 与 driver_id 是相同的。只有当两者相同时，才能用此条件排除被禁止用户的行程记录。</p><p>错误的结果：</p><table><thead><tr><th>Id</th><th>Client_Id</th><th>Driver_Id</th><th>City_Id</th><th>STATUS</th><th>Request_at</th><th>Users_Id</th><th>Banned</th><th>Role</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-01</td><td>1</td><td>No</td><td>client</td></tr><tr><td>1</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-01</td><td>10</td><td>No</td><td>driver</td></tr><tr><td>2</td><td>2</td><td>11</td><td>1</td><td>cancelled_by_driver</td><td>2013-10-01</td><td>11</td><td>No</td><td>driver</td></tr><tr><td>3</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-01</td><td>3</td><td>No</td><td>client</td></tr><tr><td>3</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-01</td><td>12</td><td>No</td><td>driver</td></tr><tr><td>4</td><td>4</td><td>13</td><td>6</td><td>cancelled_by_client</td><td>2013-10-01</td><td>4</td><td>No</td><td>client</td></tr><tr><td>4</td><td>4</td><td>13</td><td>6</td><td>cancelled_by_client</td><td>2013-10-01</td><td>13</td><td>No</td><td>driver</td></tr><tr><td>5</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-02</td><td>1</td><td>No</td><td>client</td></tr><tr><td>5</td><td>1</td><td>10</td><td>1</td><td>completed</td><td>2013-10-02</td><td>10</td><td>No</td><td>driver</td></tr><tr><td>6</td><td>2</td><td>11</td><td>6</td><td>completed</td><td>2013-10-02</td><td>11</td><td>No</td><td>driver</td></tr><tr><td>7</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-02</td><td>3</td><td>No</td><td>client</td></tr><tr><td>7</td><td>3</td><td>12</td><td>6</td><td>completed</td><td>2013-10-02</td><td>12</td><td>No</td><td>driver</td></tr><tr><td>8</td><td>2</td><td>12</td><td>12</td><td>completed</td><td>2013-10-03</td><td>12</td><td>No</td><td>driver</td></tr><tr><td>9</td><td>3</td><td>10</td><td>12</td><td>completed</td><td>2013-10-03</td><td>3</td><td>No</td><td>client</td></tr><tr><td>9</td><td>3</td><td>10</td><td>12</td><td>completed</td><td>2013-10-03</td><td>10</td><td>No</td><td>driver</td></tr><tr><td>10</td><td>4</td><td>13</td><td>12</td><td>cancelled_by_driver</td><td>2013-10-03</td><td>4</td><td>No</td><td>client</td></tr><tr><td>10</td><td>4</td><td>13</td><td>12</td><td>cancelled_by_driver</td><td>2013-10-03</td><td>13</td><td>No</td><td>driver</td></tr></tbody></table><p>结果中，被禁止的 users_id = 2，其行程记录没被剔除掉。</p><p>明显， client_id 与 driver_id 不一定相同 。</p><p>正确的做法是对 client_id 和 driver_id 各自关联的 users_id，同时检测是否被禁止。</p><pre tabindex=0><code>if (client_id = users_id_1 且 users_id_1没被禁止 并且 client_id = users_id_2 且 users_id_2没被禁止){
    此条记录没被禁止。
}
</code></pre><p>SQL 代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>U1</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>client_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U1</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>U1</span><span class=p>.</span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>U2</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>driver_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U2</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>U2</span><span class=p>.</span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>在此基础上，按日期分组，统计每组的 总行程数，取消的行程数 。</p><p>每组的总行程数：COUNT(T.STATUS)。</p><p>每组的取消的行程数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SUM</span><span class=p>(</span><span class=k>IF</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>取消率 = 每组的取消的行程数 / 每组的总行程数</p><p>完整逻辑为:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>Day</span><span class=o>`</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ROUND</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=k>IF</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=n>Cancellation</span><span class=w> </span><span class=n>Rate</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>U1</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>client_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U1</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>U1</span><span class=p>.</span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>U2</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>driver_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U2</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>U2</span><span class=p>.</span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;2013-10-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;2013-10-03&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>其中 SUM 求和函数，COUNT 计数函数，ROUND 四舍五入函数。</p><h3 id=解法二>解法二</h3><p>思路与解法一相同。而采用不同的方法排除掉被禁止用户的行程记录。想到排除，就联想到集合差。</p><p>client_id 和 driver_id 的全部为集合 U。被禁止的 users_id 集合为 A。</p><p>U 减去 A 的结果为没被禁止的用户。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A</span><span class=w>
</span></span></span></code></pre></div><p>好了，先演示一个错误的解法：</p><p>行程表连接表 A，排除掉被被禁止的行程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>剩下的逻辑与解法一后部分相同，完善后的逻辑为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>Day</span><span class=o>`</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ROUND</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=k>IF</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=n>Cancellation</span><span class=w> </span><span class=n>Rate</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;2013-10-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;2013-10-03&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>很可惜，当表 A 为空时，此方法的结果是空表。但是表 A 为空，可能是有用户但是没有被禁止的用户。因此方法是错误的。</p><p>正确的解法是：行程表 left join 表 A 两次，A.users_id 都为 NULL 的行都是没被排除的行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A1</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A1</span><span class=p>.</span><span class=n>users_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>A1</span><span class=p>.</span><span class=n>users_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>补上其它部分的逻辑为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>Day</span><span class=o>`</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ROUND</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=k>IF</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=n>Cancellation</span><span class=w> </span><span class=n>Rate</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>A1</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A1</span><span class=p>.</span><span class=n>users_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>users_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>A1</span><span class=p>.</span><span class=n>users_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;2013-10-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;2013-10-03&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=解法三>解法三</h3><p>与解法二思路相同。找出被禁止的用户后，不再连接行程表和用户表，直接从行程表中排除掉被被禁止用户的行程记录。</p><p>被禁止的用户用子查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>行程表中 client_id 和 driver_id 都在此子查询结果中的行要剔除掉。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>补上其它部分：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>Day</span><span class=o>`</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ROUND</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=k>IF</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>T</span><span class=p>.</span><span class=n>STATUS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=n>Cancellation</span><span class=w> </span><span class=n>Rate</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Trips</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Client_Id</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>Driver_Id</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>users_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>banned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Yes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;2013-10-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;2013-10-03&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>request_at</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://tategotoazarasi.github.io/js/toc.js></script><link rel=stylesheet href=https://tategotoazarasi.github.io/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://tategotoazarasi.github.io/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://tategotoazarasi.github.io/js/github-style.js></script><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></html>